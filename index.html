<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>An√°lise de Estoque - Curva ABC v2.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated Plotly CDN link -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;800&amp;display=swap" rel="stylesheet"/>
    <!-- Font Awesome for icons -->
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
    <style>
        /* Modern Minimalistic Color Palette (Adaptive) */
        :root {
            /* Light Mode Defaults */
            --primary-bg: #F0F4F8; /* Soft blue-gray for main background */
            --secondary-bg: #FFFFFF; /* Pure white for cards, crisp */
            --text-primary: #2C3E50; /* Dark desaturated blue/charcoal */
            --text-secondary: #7F8C8D; /* Medium gray for subtle text */
            --border-color: #D1D9E0; /* Light blue-gray for borders */
            --accent-main: #6A60A9; /* A deeper, more sophisticated violet */
            --accent-hover: #5C5394; /* Darker violet for hover */

            /* Status Colors */
            --status-critical: #E74C3C; /* Red for critical */
            --status-alert: #F39C12; /* A warm, rich orange for alert */
            --status-normal: #27AE60; /* A slightly deeper green for normal */

            /* ABC Category Colors (Light Mode) */
            --abc-a-color: #C0392B; /* Stronger Red/Burgundy for A */
            --abc-b-color: #E67E22; /* Vibrant Orange for B */
            --abc-c-color: #2ECC71; /* Calmer Green for C */

            /* Card specific shadow for minimalism */
            --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04); /* Softer, more dispersed shadow */

            /* Light mode specific tints for colored backgrounds */
            --status-critical-bg-tint: rgba(231, 76, 60, 0.12);
            --status-alert-bg-tint: rgba(243, 156, 18, 0.12);
            --status-normal-bg-tint: rgba(39, 174, 96, 0.12);

            /* Header Specific Colors (Light Mode) */
            --header-bg-color: #4A437C; /* Darker violet for header */
            --header-text-color: #FFFFFF;
            --header-icon-color: #E0E6EB; /* Lighter border color for icons */

            /* RGB for border-color for rgba use */
            --border-color-rgb: 209, 217, 224; /* RGB for #D1D9E0 */
            --accent-main-rgb: 106, 96, 169; /* RGB for #6A60A9 */
        }

        /* Dark Mode Overrides */
        body.dark-mode {
            --primary-bg: #1A202C; /* Darker charcoal blue */
            --secondary-bg: #2D3748; /* Slightly lighter dark blue-gray for cards */
            --text-primary: #F8F9FA; /* Off-white for main text */
            --text-secondary: #A9B4C4; /* Light gray for subtle text */
            --border-color: #4A5568; /* Darker blue-gray for borders */
            --accent-main: #9F95E0; /* Brighter, muted violet for dark mode accent */
            --accent-hover: #8A80C7; /* Slightly darker brighter violet for hover */

            /* Status Colors (Dark Mode adjusted) */
            --status-critical: #E74C3C;
            --status-alert: #F39C12;
            --status-normal: #27AE60;

            /* ABC Category Colors (Dark Mode) */
            --abc-a-color: #E74C3C;
            --abc-b-color: #F39C12;
            --abc-c-color: #2ECC71;

            /* Dark mode specific tints for colored backgrounds */
            --status-critical-bg-tint: rgba(231, 76, 60, 0.3);
            --status-alert-bg-tint: rgba(243, 156, 18, 0.3);
            --status-normal-bg-tint: rgba(39, 174, 96, 0.3);

            /* Header Specific Colors (Dark Mode) */
            --header-bg-color: var(--primary-bg);
            --header-text-color: #F8F9FA;
            --header-icon-color: #BCC3CE;

            /* RGB for border-color for rgba use */
            --border-color-rgb: 74, 85, 104;
            --accent-main-rgb: 159, 149, 224;
        }

        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            line-height: 1.6; /* Increased line-height for body text */
        }

        /* Main content layer */
        #app {
            position: relative;
            z-index: 1;
            background-color: transparent;
        }

        /* Typography adjustments */
        h1 { font-weight: 800; } /* Extra bold for H1 */
        h2 { font-weight: 700; } /* Bold for H2 */
        h3 { font-weight: 600; } /* Semi-bold for H3 */

        input[type="text"],
        input[type="number"],
        select {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* Refined focus state for inputs/selects */
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--accent-main); /* Change border color on focus */
            outline: none; /* Remove default outline */
            box-shadow: 0 0 0 2px rgba(var(--accent-main-rgb), 0.3); /* Custom focus ring */
        }


        /* Table styles */
        table thead th {
            color: var(--text-secondary);
        }

        table tbody td {
            color: var(--text-primary);
            font-size: 0.875rem; /* text-sm */
        }

        /* Specific header styling */
        .header-bg {
            background-color: var(--header-bg-color);
            color: var(--header-text-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 20;
            /* Added subtle gradient for header */
            background-image: linear-gradient(to right, var(--header-bg-color), var(--accent-main));
        }

        .header-icon {
            color: var(--header-icon-color);
        }

        /* Card styles */
        .card {
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.08); /* More pronounced hover shadow */
        }

        /* Category concept colors with adaptive backgrounds */
        .concept-A {
            border-left: 4px solid var(--status-critical);
            background-color: var(--status-critical-bg-tint);
        }

        .concept-B {
            border-left: 4px solid var(--status-alert);
            background-color: var(--status-alert-bg-tint);
        }

        .concept-C {
            border-left: 4px solid var(--status-normal);
            background-color: var(--status-normal-bg-tint);
        }

        /* Home page specific concept boxes */
        .concept-A-home {
            background-color: var(--status-critical-bg-tint);
            border-color: var(--status-critical);
            color: var(--text-primary);
        }
        .concept-B-home {
            background-color: var(--status-alert-bg-tint);
            border-color: var(--status-alert);
            color: var(--text-primary);
        }
        .concept-C-home {
            background-color: var(--status-normal-bg-tint);
            border-color: var(--status-normal);
            color: var(--text-primary);
        }

        /* Critical item pulse animation */
        .critical-item-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        /* Table overflow */
        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .flex-col-md {
                flex-direction: column;
            }

            .w-full-md {
                width: 100% !important;
            }
        }

        /* Styling for modal scroll */
        #itemModal,
        #itemFormModal,
        #confirmationModal {
            backdrop-filter: blur(5px); /* Apply blur directly to the overlay */
            background-color: rgba(0, 0, 0, 0.5); /* Keep overlay dark */
        }

        #itemModal > div,
        #itemFormModal > div,
        #confirmationModal > div {
            max-height: 90vh;
            transition: all 0.3s ease-out;
            transform: scale(0.95);
            opacity: 0;
            /* Removed backdrop-filter and background-color from here */
            background-color: var(--secondary-bg); /* Ensure modal content has its own background */
        }
        /* State when modal is open */
        #itemModal.block > div,
        #itemFormModal.block > div,
        #confirmationModal.block > div {
            transform: scale(1);
            opacity: 1;
        }

        #itemModal > div > div,
        #itemFormModal > div > div {
            overflow-y: auto;
            padding-right: 1rem;
        }

        /* Hide scrollbar for a cleaner look on desktop, but allow scroll */
        #itemModal > div > div::-webkit-scrollbar,
        #itemFormModal > div > div::-webkit-scrollbar,
        ::-webkit-scrollbar {
            width: 8px;
        }
        #itemModal > div > div::-webkit-scrollbar-track,
        #itemFormModal > div > div::-webkit-scrollbar-track {
            background: var(--primary-bg);
        }
        #itemModal > div > div::-webkit-scrollbar-thumb,
        #itemFormModal > div > div::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        /* Button refinements for minimalism */
        button {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        /* Primary accent button */
        .btn-primary {
            background-color: var(--accent-main);
            color: var(--primary-bg);
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px); /* Slight lift on hover */
        }
        .btn-primary:active {
            transform: translateY(0); /* Press effect */
        }

        /* Gradient button for CTA */
        .btn-gradient {
            background-image: linear-gradient(to right, var(--accent-main), var(--accent-hover));
            color: var(--primary-bg);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-gradient:hover {
            background-image: linear-gradient(to right, var(--accent-hover), var(--accent-main));
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-gradient:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Secondary/Outline button */
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }

        /* Specific button overrides */
        #resetData {
            background-color: var(--status-critical);
            color: var(--primary-bg);
        }
        #resetData:hover {
            background-color: var(--status-critical);
            opacity: 0.9;
        }

        #sampleData,
        #sampleDataMain {
            background-color: var(--status-alert);
            color: var(--primary-bg);
        }
        #sampleData:hover,
        #sampleDataMain:hover {
            background-color: var(--status-alert);
            opacity: 0.9;
        }

        #addNewItemBtn,
        #editItemBtn {
            background-color: var(--accent-main);
            color: var(--primary-bg);
        }
        #addNewItemBtn:hover,
        #editItemBtn:hover {
            background-color: var(--accent-hover);
        }

        .view-item-btn {
            background-color: transparent;
            color: var(--accent-main);
            border: none;
            padding: 0.2rem 0.5rem;
        }
        .view-item-btn:hover {
            color: var(--accent-hover);
            background-color: rgba(var(--accent-main-rgb), 0.1);
        }

        .delete-item-btn {
            background-color: transparent;
            color: var(--status-critical);
            border: none;
            padding: 0.2rem 0.5rem;
        }
        .delete-item-btn:hover {
            color: var(--status-critical);
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* Specific status button colors */
        #filterA, #filterB, #filterC, #filterCritical, #filterAlert, #filterNormal, #filterAllItems {
            background-color: transparent; /* Default to transparent */
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        #filterA.active, #filterA:hover {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--status-critical);
            border-color: var(--status-critical);
        }
        #filterB.active, #filterB:hover {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--status-alert);
            border-color: var(--status-alert);
        }
        #filterC.active, #filterC:hover {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--status-normal);
            border-color: var(--status-normal);
        }
        #filterCritical.active, #filterCritical:hover {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--status-critical);
            border-color: var(--status-critical);
        }
        #filterAlert.active, #filterAlert:hover {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--status-alert);
            border-color: var(--status-alert);
        }
        #filterNormal.active, #filterNormal:hover {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--status-normal);
            border-color: var(--status-normal);
        }
        #filterAllItems.active, #filterAllItems:hover {
            background-color: rgba(var(--accent-main-rgb), 0.1);
            color: var(--accent-main);
            border-color: var(--accent-main);
        }

        /* Dark mode specific for filters */
        body.dark-mode #filterA.active, body.dark-mode #filterA:hover { background-color: rgba(231, 76, 60, 0.3); border-color: rgba(231, 76, 60, 0.4); }
        body.dark-mode #filterB.active, body.dark-mode #filterB:hover { background-color: rgba(243, 156, 18, 0.3); border-color: rgba(243, 156, 18, 0.4); }
        body.dark-mode #filterC.active, body.dark-mode #filterC:hover { background-color: rgba(39, 174, 96, 0.3); border-color: rgba(39, 174, 96, 0.4); }
        body.dark-mode #filterCritical.active, body.dark-mode #filterCritical:hover { background-color: rgba(231, 76, 60, 0.3); border-color: rgba(231, 76, 60, 0.4); }
        body.dark-mode #filterAlert.active, body.dark-mode #filterAlert:hover { background-color: rgba(243, 156, 18, 0.3); border-color: rgba(243, 156, 18, 0.4); }
        body.dark-mode #filterNormal.active, body.dark-mode #filterNormal:hover { background-color: rgba(39, 174, 96, 0.3); border-color: rgba(39, 174, 96, 0.4); }
        body.dark-mode #filterAllItems.active, body.dark-mode #filterAllItems:hover { background-color: rgba(var(--accent-main-rgb), 0.3); color: var(--accent-main); border: 1px solid rgba(var(--accent-main-rgb), 0.4); }

        /* Dashboard card colors */
        .dashboard-card-primary {
            background-color: var(--accent-main);
            color: var(--primary-bg);
        }
        .dashboard-card-secondary {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .dashboard-card-text-light {
            color: var(--primary-bg);
        }
        .dashboard-card-text-dark {
            color: var(--text-secondary);
        }

        .dashboard-card-critical {
            background-color: var(--status-critical);
            color: var(--primary-bg);
        }
        .dashboard-card-alert {
            background-color: var(--status-alert);
            color: var(--primary-bg);
        }
        .dashboard-card-normal {
            background-color: var(--status-normal);
            color: var(--primary-bg);
        }

        /* LLM action plan button */
        #generateActionPlanBtn {
            background-color: #7B68EE; /* A slightly softer violet-blue */
            color: #FFFFFF;
        }
        #generateActionPlanBtn:hover {
            background-color: #6A5ACD; /* Darker on hover */
        }

        /* Modal specific styling */
        #itemModal > div,
        #itemFormModal > div,
        #confirmationModal > div {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
        }
        #itemModal .text-gray-500,
        #itemFormModal .text-gray-500,
        #confirmationModal .text-gray-500 {
            color: var(--text-secondary);
        }
        #llmActionPlanContent {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Navigation links */
        .nav-link {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            color: var(--header-text-color);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 1rem;
            font-weight: bold;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2); /* More noticeable hover */
            transform: translateY(-1px); /* Slight lift */
        }
        body.dark-mode .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .nav-link.active {
            background-color: var(--accent-hover); /* Use accent-hover for active to differentiate */
            color: var(--primary-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Subtle shadow for active state */
        }
        .nav-link.active:hover {
            background-color: var(--accent-main); /* Slightly different hover for active */
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .animate-pulse-icon {
            animation: pulse 1.5s infinite;
        }

        /* Adjusted hover for general elements that use border-color background */
        .hover\:bg-border-color:hover {
            background-color: rgba(var(--border-color-rgb), 0.5);
        }
        body.dark-mode .hover\:bg-border-color:hover {
             background-color: rgba(255,255,255,0.05);
        }

        /* Custom border classes for status items */
        .border-status-critical {
            border-color: var(--status-critical);
        }
        .border-status-alert {
            border-color: var(--status-alert);
        }
        .border-status-normal {
            border-color: var(--status-normal);
        }

        /* Styles for drag-and-drop area */
        .drag-area {
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .drag-area.active {
            border-color: var(--accent-main);
            background-color: rgba(var(--accent-main-rgb), 0.08);
            transform: scale(1.02);
        }

        .drag-area input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 10;
        }

        .drag-area-text {
            color: var(--text-secondary);
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            max-width: 350px;
            opacity: 0;
            transform: translateX(100%); /* Start off-screen */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            border-left: 5px solid var(--border-color);
            display: flex; /* Added for icon alignment */
            align-items: center; /* Added for icon alignment */
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0); /* Slide in */
        }

        .toast.success {
            border-color: var(--status-normal);
        }
        .toast.error {
            border-color: var(--status-critical);
        }
        .toast.info {
            border-color: var(--accent-main);
        }
        /* Toast Icons */
        .toast .toast-icon {
            margin-right: 0.75rem; /* Space between icon and text */
            font-size: 1.25rem; /* Icon size */
        }
        .toast.success .toast-icon { color: var(--status-normal); }
        .toast.error .toast-icon { color: var(--status-critical); }
        .toast.info .toast-icon { color: var(--accent-main); }


        body.dark-mode select {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        /* Skeleton Loading styles */
        .skeleton-loading {
            animation: pulse-skeleton 1.5s infinite ease-in-out;
            background: linear-gradient(to right, var(--primary-bg) 0%, var(--border-color) 50%, var(--primary-bg) 100%);
            background-size: 200% 100%;
            border-radius: 4px;
        }

        @keyframes pulse-skeleton {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-row {
            height: 3rem; /* Approximate height of a table row */
            margin-bottom: 0.5rem;
        }

        /* Plotly Custom Tooltip */
        .plotly-tooltip {
            font-family: 'Inter', sans-serif !important;
            font-size: 0.875rem !important; /* text-sm */
            background-color: var(--secondary-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
            padding: 0.75rem 1rem !important;
        }
        .plotly-tooltip .point-label {
            font-weight: 600 !important;
            color: var(--accent-main) !important;
        }
        .plotly-tooltip .point-value {
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col" id="app">
        <!-- Header (always visible) -->
        <header class="header-bg p-6 shadow-lg">
            <div class="container mx-auto flex justify-between items-center flex-wrap">
                <div class="flex items-center">
                    <i class="fas fa-warehouse text-3xl mr-4 header-icon"></i>
                    <h1 class="text-3xl md:text-4xl font-extrabold" style="color: var(--header-text-color);">An√°lise de Estoque - Curva ABC</h1>
                </div>
                <nav class="flex items-center space-x-6 mt-4 md:mt-0">
                    <button class="nav-link font-medium" id="navHomeBtn">
                        <i class="fas fa-home mr-2"></i>In√≠cio
                    </button>
                    <button class="nav-link font-medium" id="navInventoryBtn">
                        <i class="fas fa-chart-bar mr-2"></i>An√°lise de Estoque
                    </button>
                    <button class="nav-link font-medium" id="navAllItemsBtn">
                        <i class="fas fa-list-alt mr-2"></i>Todos os Itens
                    </button>
                    <button class="nav-link font-medium" id="navPriorityItemsBtn">
                        <i class="fas fa-tasks mr-2"></i>Itens Priorit√°rios
                    </button>
                </nav>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <span class="text-sm" id="currentSystemDate" style="color: var(--header-text-color);"></span>
                    <button class="p-2 rounded-full hover:bg-border-color focus:outline-none focus:ring-2 focus:ring-accent-main" id="toggleDarkMode" style="color: var(--header-icon-color);">
                        <i class="fas fa-moon text-xl"></i>
                    </button>
                    <!-- New: Export Presentation Button -->
                    <button class="p-2 rounded-full hover:bg-border-color focus:outline-none focus:ring-2 focus:ring-accent-main" id="exportPresentationBtn" style="color: var(--header-icon-color);">
                        <i class="fas fa-file-powerpoint text-xl"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="container mx-auto px-4 py-8 flex-grow">
            <!-- Home View -->
            <section class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] text-center" id="homeView">
                <div class="bg-secondary-bg p-8 md:p-12 rounded-xl shadow-lg max-w-2xl w-full card">
                    <i class="fas fa-chart-pie text-accent-main text-6xl mb-6 animate-pulse-icon"></i>
                    <h2 class="text-3xl md:text-4xl font-bold text-text-primary mb-4">Sistema de An√°lise de Estoque - Almoxarifado - PMB</h2>
                    <p class="text-lg text-text-secondary mb-8 leading-relaxed">
                        A **Curva ABC** √© uma ferramenta de gest√£o que classifica itens de estoque com base na sua import√¢ncia. Neste sistema, a classifica√ß√£o √© feita pela **frequ√™ncia de pedidos (CONTAGEM)**, ou seja, quantos pedidos cada item teve nos √∫ltimos 2 anos. Ela divide os itens em tr√™s categorias principais:
                    </p>
                    <ul class="text-base space-y-4 my-6 text-left">
                        <li class="p-4 rounded-lg border concept-A-home">
                            <strong class="text-status-critical">Categoria A (Itens de Alta Frequ√™ncia):</strong> Pequena quantidade de itens que representam a maior parte dos pedidos. Exigem controle rigoroso e alta disponibilidade.
                        </li>
                        <li class="p-4 rounded-lg border concept-B-home">
                            <strong class="text-status-alert">Categoria B (Itens de M√©dia Frequ√™ncia):</strong> Quantidade moderada de itens com frequ√™ncia de pedidos intermedi√°ria. Requerem monitoramento regular.
                        </li>
                        <li class="p-4 rounded-lg border concept-C-home">
                            <strong class="text-status-normal">Categoria C (Itens de Baixa Frequ√™ncia):</strong> Grande quantidade de itens com menor frequ√™ncia de pedidos. Podem ter controle mais simplificado.
                        </li>
                    </ul>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center">
                        <button class="btn-gradient text-base px-6 py-2 font-semibold" id="homeGoToInventoryBtn">
                            <i class="fas fa-arrow-right mr-2"></i>Iniciar An√°lise
                        </button>
                        <button class="btn-secondary text-base px-6 py-2 font-semibold" id="homeSampleDataBtn">
                            <i class="fas fa-vial mr-2"></i>Ver Dados de Exemplo
                        </button>
                    </div>
                </div>
            </section>

            <!-- Inventory Analysis View (initially hidden) -->
            <div class="hidden" id="inventoryView">
                <!-- Upload Section (stays here as it is primary for data input) -->
                <section class="mb-8" id="importDataSection">
                    <div class="rounded-lg shadow-md p-6 card" style="background-color: var(--secondary-bg);">
                        <!-- Container for elements to be hidden/shown -->
                        <div id="uploadControlsContainer" class="hidden">
                            <h2 class="text-2xl font-bold mb-4 text-text-primary" id="importSectionTitle">Importar Dados</h2>
                            <p class="mb-4 text-text-secondary leading-relaxed" id="importSectionDescription">Fa√ßa upload de uma planilha Excel (.xlsx, .xls) ou LibreOffice Calc (.ods) contendo os dados de estoque.</p>
                            <p class="text-sm text-text-secondary mb-4 p-3 border border-border-color rounded-md bg-primary-bg leading-relaxed" id="importSectionLegend">
                                **Colunas obrigat√≥rias no arquivo (nomes exatos ou sin√≥nimos reconhecidos):**<br/>
                                - **FICHA**: C√≥digo ou identificador √∫nico do item. Sin√≥nimos: ID, Codigo, C√ìDIGO, SKU.<br/>
                                - **DESCRICAO_MATERIAL**: Descri√ß√£o detalhada do item. Sin√≥nimos: Descricao Material, DESCRI√á√ÉO, MATERIAL, Item.<br/>
                                - **PRECO_MEDIO**: Pre√ßo m√©dio unit√°rio do item. Sin√≥nimos: Pre√ßo M√©dio, Preco Medio, Custo M√©dio, Custo Medio, Valor Unit√°rio.<br/>
                                - **ESTOQUE_ATUAL**: Quantidade atual do item em estoque. Sin√≥nimos: Estoque Atual, Qtd Estoque, Quantidade Atual.<br/>
                                - **CONTAGEM**: N√∫mero de pedidos do item nos √∫ltimos 2 anos. Sin√≥nimos: Pedidos, Frequ√™ncia, Contagem Pedidos.<br/>
                                - **CATEGORIA_MATERIAL**: Categoria do material (Ex: Eletr√¥nicos, Ferramentas). Sin√≥nimos: Categoria, Tipo Material.
                            </p>
                            <!-- Drag and Drop Area -->
                            <div class="drag-area p-6 mb-4 flex flex-col items-center justify-center" id="dropArea">
                                <input accept=".xlsx,.xls,.ods" id="fileInput" type="file"/>
                                <i class="fas fa-cloud-upload-alt text-4xl text-text-secondary mb-3"></i>
                                <p class="text-lg font-medium text-text-primary">Arraste e solte o arquivo aqui</p>
                                <label class="btn-primary font-semibold text-center px-4 py-2 rounded-md cursor-pointer mt-3" for="fileInput">
                                    <i class="fas fa-file-upload mr-2"></i>Escolher Arquivo
                                </label>
                            </div>
                            <div class="mt-2 text-sm text-text-secondary hidden text-center" id="fileInfo">
                                Arquivo selecionado: <span class="font-medium" id="fileName"></span> <span class="ml-2 text-text-secondary" id="importDate"></span>
                            </div>
                        </div>
                        <div class="mt-4 text-accent-main hidden text-center" id="loadingIndicator">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Carregando dados...
                        </div>
                        <div class="mt-4 text-status-critical hidden text-center" id="columnError"></div>
                        <div class="flex flex-col md:flex-row items-center mt-4 justify-center md:justify-start">
                            <button class="btn-secondary px-4 py-2 rounded-md mb-4 md:mb-0 md:mr-4" id="resetData">
                                <i class="fas fa-trash-alt mr-2"></i>Limpar Dados
                            </button>
                            <button class="btn-secondary px-4 py-2 rounded-md md:mr-4" id="sampleData">
                                <i class="fas fa-vial mr-2"></i>Dados de Exemplo
                            </button>
                            <button class="btn-primary px-4 py-2 rounded-md" id="addNewItemBtn">
                                <i class="fas fa-plus mr-2"></i>Adicionar Novo Item
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Dashboard (remains here) -->
                <section class="hidden" id="dashboardSection">
                    <div class="mb-8">
                        <div class="rounded-lg shadow-md p-6 card" style="background-color: var(--secondary-bg);">
                            <h2 class="text-2xl font-bold mb-4 text-text-primary">Painel de Controle</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="dashboard-card-primary p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Valor Total Estoque</h3>
                                    <p class="text-2xl font-bold mt-2" id="totalStockValue">0</p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Valor monet√°rio total</p>
                                </div>
                                <div class="dashboard-card-secondary p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider text-text-primary">Total de Itens Cadastrados</h3>
                                    <p class="text-2xl font-bold mt-2" id="totalItemsCount">0</p>
                                    <p class="text-xs mt-1 text-text-secondary">N√∫mero total de SKUs</p>
                                </div>
                                <div class="dashboard-card-primary p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Itens Categoria A (Pedidos)</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countA">0</span> <span class="text-lg dashboard-card-text-light" id="percentA"></span></p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Alta frequ√™ncia de pedidos</p>
                                </div>
                                <div class="dashboard-card-secondary p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider text-text-primary">Itens Categoria B (Pedidos)</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countB">0</span> <span class="text-lg text-text-secondary" id="percentB"></span></p>
                                    <p class="text-xs mt-1 text-text-secondary">M√©dia frequ√™ncia de pedidos</p>
                                </div>
                                <div class="dashboard-card-primary p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Itens Categoria C (Pedidos)</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countC">0</span> <span class="text-lg dashboard-card-text-light" id="percentC"></span></p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Baixa frequ√™ncia de pedidos</p>
                                </div>
                                <div class="dashboard-card-critical p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Itens Cr√≠ticos</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countCritical">0</span> <span class="text-lg dashboard-card-text-light" id="percentCritical"></span></p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Estoque atual menor que as sa√≠das mensais</p>
                                </div>
                                <div class="dashboard-card-alert p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Itens em Alerta</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countAlert">0</span> <span class="text-lg dashboard-card-text-light" id="percentAlert"></span></p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Estoque atual inferior √†s sa√≠das de dois meses (but not critical)</p>
                                </div>
                                <div class="dashboard-card-normal p-4 rounded-lg">
                                    <h3 class="text-sm font-medium uppercase tracking-wider dashboard-card-text-light">Itens Normais</h3>
                                    <p class="text-2xl font-bold mt-2"><span id="countNormal">0</span> <span class="text-lg dashboard-card-text-light" id="percentNormal"></span></p>
                                    <p class="text-xs mt-1 dashboard-card-text-light">Estoque atual superior ou igual √†s sa√≠das de dois meses</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts (remains here) -->
                    <div class="mb-8">
                        <div class="rounded-lg shadow-md p-6 card" style="background-color: var(--secondary-bg);">
                            <h2 class="text-2xl font-bold mb-4 text-text-primary">Visualiza√ß√µes</h2>
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">An√°lise ABC (por Contagem de Pedidos)</h3>
                                    <div class="flex space-x-2 items-center">
                                        <span class="text-sm text-text-secondary">Filtrar por Categoria do Material:</span>
                                        <select class="px-3 py-1 rounded-md text-sm bg-secondary-bg text-text-primary border border-border-color focus:ring-accent-main focus:border-accent-main" id="abcMaterialCategoryFilter">
                                            <option value="Todos">Todos</option>
                                            <!-- Options populated by JS -->
                                        </select>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportABCChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportABCDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="h-80 md:h-96" id="abcChart"></div> <!-- Increased height for responsiveness -->
                            </div>
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">Situa√ß√£o do Estoque (N√∫mero de Itens)</h3>
                                    <div class="flex space-x-2 items-center">
                                        <span class="text-sm text-text-secondary">Filtrar por Categoria do Material:</span>
                                        <select class="px-3 py-1 rounded-md text-sm bg-secondary-bg text-text-primary border border-border-color focus:ring-accent-main focus:border-accent-main" id="stockMaterialCategoryFilter">
                                            <option value="Todos">Todos</option>
                                            <!-- Options populated by JS -->
                                        </select>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportStockChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportStockDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="h-80 md:h-96" id="stockChart"></div> <!-- Increased height for responsiveness -->
                            </div>

                            <!-- Material Category Chart Section -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">Distribui√ß√£o por Categoria de Material</h3>
                                    <div class="flex space-x-2">
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportMaterialCategoryChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportMaterialCategoryDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="h-80 md:h-96" id="materialCategoryChart"></div> <!-- Increased height for responsiveness -->
                            </div>

                            <!-- NEW: Representativeness Donut Chart Section (Replaces the "Representatividade de Cada Categoria de Material (Valor Total do Estoque)" bar chart) -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">Representatividade de Cada Categoria de Material (Valor Total do Estoque)</h3>
                                    <div class="flex space-x-2 items-center">
                                        <span class="text-sm text-text-secondary">Filtrar por Categoria do Material:</span>
                                        <!-- Multi-select dropdown for categories -->
                                        <div class="relative inline-block text-left">
                                            <button type="button" class="inline-flex justify-center w-full rounded-md border border-border-color shadow-sm px-3 py-1 bg-secondary-bg text-sm font-medium text-text-primary hover:bg-primary-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-main" id="multiSelectCategoryBtn_representativeness" aria-haspopup="true" aria-expanded="true">
                                                Categorias <i class="fas fa-chevron-down ml-2 -mr-1 text-xs"></i>
                                            </button>
                                            <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-secondary-bg ring-1 ring-black ring-opacity-5 focus:outline-none z-10 hidden" id="multiSelectCategoryDropdown_representativeness">
                                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="multiSelectCategoryBtn_representativeness">
                                                    <!-- Checkboxes will be populated here by JS -->
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportRepresentativenessDonutChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportRepresentativenessDonutDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <!-- Container for the chart to ensure proper centering and height -->
                                <div class="h-[450px] w-full flex justify-center items-center" id="representativenessDonutChartContainer">
                                    <div class="h-full w-full" id="representativenessDonutChart"></div>
                                </div>
                                <!-- Moved "Valor Total Filtrado" below the chart -->
                                <div class="p-4 rounded-lg bg-primary-bg border border-border-color mt-4 text-center">
                                    <h4 class="text-sm font-medium uppercase tracking-wider text-text-secondary mb-2">Valor Total Filtrado</h4>
                                    <p class="text-2xl font-bold text-accent-main" id="representativenessTotalValue">0</p>
                                </div>
                            </div>

                            <!-- NEW: Consumo Anual por Categoria de Material (Donut Chart - Replaces last bar chart) -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">Consumo Anual por Categoria de Material (Valor Monet√°rio)</h3>
                                    <div class="flex space-x-2 items-center">
                                        <span class="text-sm text-text-secondary">Filtrar por Categoria do Material:</span>
                                        <!-- Multi-select dropdown for categories -->
                                        <div class="relative inline-block text-left">
                                            <button type="button" class="inline-flex justify-center w-full rounded-md border border-border-color shadow-sm px-3 py-1 bg-secondary-bg text-sm font-medium text-text-primary hover:bg-primary-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-main" id="multiSelectCategoryBtn_consumption" aria-haspopup="true" aria-expanded="true">
                                                Categorias <i class="fas fa-chevron-down ml-2 -mr-1 text-xs"></i>
                                            </button>
                                            <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-secondary-bg ring-1 ring-black ring-opacity-5 focus:outline-none z-10 hidden" id="multiSelectCategoryDropdown_consumption">
                                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="multiSelectCategoryBtn_consumption">
                                                    <!-- Checkboxes will be populated here by JS -->
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportConsumptionMaterialCategoryChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportConsumptionMaterialCategoryDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="h-[450px] w-full flex justify-center items-center" id="consumptionMaterialCategoryChartContainer">
                                    <div class="h-full w-full" id="consumptionMaterialCategoryChart"></div>
                                </div>
                                <div class="p-4 rounded-lg bg-primary-bg border border-border-color mt-4 text-center">
                                    <h4 class="text-sm font-medium uppercase tracking-wider text-text-secondary mb-2">Consumo Anual Total Filtrado</h4>
                                    <p class="text-2xl font-bold text-accent-main" id="consumptionTotalValue">0</p>
                                </div>
                            </div>

                            <!-- NEW: Estoque Atual vs. Consumo Anual (Stacked Bar Chart - Replaces bubble chart) -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-xl font-semibold text-text-primary">Estoque Atual vs. Consumo Anual por Categoria de Material</h3>
                                    <div class="flex space-x-2 items-center">
                                        <span class="text-sm text-text-secondary">Filtrar por Categoria do Material:</span>
                                        <!-- Multi-select dropdown for categories -->
                                        <div class="relative inline-block text-left">
                                            <button type="button" class="inline-flex justify-center w-full rounded-md border border-border-color shadow-sm px-3 py-1 bg-secondary-bg text-sm font-medium text-text-primary hover:bg-primary-bg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-main" id="multiSelectCategoryBtn_stockVsConsumption" aria-haspopup="true" aria-expanded="true">
                                                Categorias <i class="fas fa-chevron-down ml-2 -mr-1 text-xs"></i>
                                            </button>
                                            <div class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-secondary-bg ring-1 ring-black ring-opacity-5 focus:outline-none z-10 hidden" id="multiSelectCategoryDropdown_stockVsConsumption">
                                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="multiSelectCategoryBtn_stockVsConsumption">
                                                    <!-- Checkboxes will be populated here by JS -->
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportStockVsConsumptionChart">
                                            <i class="fas fa-image mr-1"></i>Exportar Imagem
                                        </button>
                                        <button class="btn-secondary text-xs px-2 py-1" id="exportStockVsConsumptionDataExcel">
                                            <i class="fas fa-file-excel mr-1"></i>Exportar Excel
                                        </button>
                                    </div>
                                </div>
                                <div class="h-80 md:h-96" id="stockVsConsumptionScatterChart"></div>
                            </div>

                        </div>
                    </div>

                    <!-- Insights (remains here) -->
                    <div class="mb-8">
                        <div class="rounded-lg shadow-md p-6 card" style="background-color: var(--secondary-bg);">
                            <h2 class="text-2xl font-bold mb-4 text-text-primary">Insights e Recomenda√ß√µes (Baseado na Frequ√™ncia de Pedidos)</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="concept-A p-4 rounded-lg">
                                    <h3 class="font-bold text-lg text-status-critical mb-2">Categoria A (Alta Frequ√™ncia de Pedidos)</h3>
                                    <p class="text-sm text-text-secondary mb-3 leading-relaxed">Representam uma pequena quantidade de itens, mas com a maior frequ√™ncia de pedidos.</p>
                                    <ul class="text-xs list-disc pl-5 space-y-1 text-text-primary">
                                        <li>Foco no controle rigoroso de estoque e disponibilidade.</li>
                                        <li>Previs√£o precisa da demanda baseada no hist√≥rico de pedidos.</li>
                                        <li>Estoque de seguran√ßa bem definido para evitar rupturas.</li>
                                        <li>Monitoramento frequente (di√°rio/semanal) da movimenta√ß√£o.</li>
                                        <li>Otimiza√ß√£o de processos de reabastecimento.</li>
                                    </ul>
                                </div>
                                <div class="concept-B p-4 rounded-lg">
                                    <h3 class="font-bold text-lg text-status-alert mb-2">Categoria B (M√©dia Frequ√™ncia de Pedidos)</h3>
                                    <p class="text-sm text-text-secondary mb-3 leading-relaxed">Quantidade moderada de itens com frequ√™ncia de pedidos intermedi√°ria.</p>
                                    <ul class="text-xs list-disc pl-5 space-y-1 text-text-primary">
                                        <li>Controle moderado de estoque.</li>
                                        <li>Revis√£o peri√≥dica (quinzenal/mensal) dos n√≠veis de estoque.</li>
                                        <li>Estoque de seguran√ßa adequado, mas menor que categoria A.</li>
                                        <li>Pedidos programados com base na demanda.</li>
                                        <li>An√°lise de sazonalidade para otimizar compras.</li>
                                    </ul>
                                </div>
                                <div class="concept-C p-4 rounded-lg">
                                    <h3 class="font-bold text-lg text-status-normal mb-2">Categoria C (Baixa Frequ√™ncia de Pedidos)</h3>
                                    <p class="text-sm text-text-secondary mb-3 leading-relaxed">Grande quantidade de itens com menor frequ√™ncia de pedidos.</p>
                                    <ul class="text-xs list-disc pl-5 space-y-1 text-text-primary">
                                        <li>Controle simplificado.</li>
                                        <li>Revis√µes ocasionais (bimestral/trimestral).</li>
                                        <li>Estoque m√≠nimo ou pedidos sob demanda.</li>
                                        <li>Considerar compra em grandes quantidades para reduzir custos de pedido.</li>
                                        <li>Avaliar a necessidade de manter o item em estoque ou terceirizar.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State (for inventory view) -->
                    <section class="text-center py-12" id="emptyState">
                        <div class="max-w-md mx-auto">
                            <i class="fas fa-box-open text-border-color text-5xl mb-4"></i>
                            <h2 class="text-2xl font-bold text-text-primary mb-2">Nenhum dado carregado</h2>
                            <p class="text-text-secondary mb-6 leading-relaxed">Fa√ßa upload de um arquivo Excel ou use nossos dados de exemplo para come√ßar a an√°lise de estoque.</p>
                            <button class="btn-gradient font-medium px-6 py-2 rounded-md" id="sampleDataMain">
                                <i class="fas fa-vial mr-2"></i>Usar Dados de Exemplo
                            </button>
                        </div>
                    </section>
                </div>

                <!-- All Items View -->
                <div class="hidden" id="allItemsView">
                    <section class="mb-8">
                        <div class="rounded-lg shadow-md p-6 card" style="background-color: var(--secondary-bg);">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                                <h2 class="text-2xl font-bold mb-2 md:mb-0 text-text-primary">Todos os Itens do Invent√°rio</h2>
                                <div class="w-full md:w-64">
                                    <div class="relative">
                                        <input class="w-full px-4 py-2 border border-border-color rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="searchInput" placeholder="Pesquisar materiais..." type="text"/>
                                        <button class="absolute right-3 top-2 text-text-secondary">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-wrap justify-between items-center mb-4">
                                <div class="text-sm text-text-secondary mb-2 md:mb-0">
                                    Exibindo <span id="showingItems">0</span> de <span id="totalItems">0</span> itens
                                </div>
                                <div class="flex flex-wrap space-x-2 mt-2">
                                    <!-- Export buttons for All Items -->
                                    <button class="btn-secondary px-3 py-1 text-sm" id="exportAllExcel">
                                        <i class="fas fa-file-excel mr-1"></i>Excel
                                    </button>
                                    <button class="btn-secondary px-3 py-1 text-sm" id="exportAllCSV">
                                        <i class="fas fa-file-csv mr-1"></i>CSV
                                    </button>
                                    <button class="btn-secondary px-3 py-1 text-sm" id="exportAllPDF">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-wrap space-x-2 mt-4 items-center">
                                <span class="text-sm text-text-secondary">Filtrar por Categoria ABC:</span>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterA">
                                    A
                                </button>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterB">
                                    B
                                </button>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterC">
                                    C
                                </button>
                                <span class="text-sm text-text-secondary ml-4">Filtrar por Situa√ß√£o do Estoque:</span>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterCritical">
                                    Cr√≠tico
                                </button>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterAlert">
                                    Alerta
                                </button>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterNormal">
                                    Normal
                                </button>
                                <span class="text-sm text-text-secondary ml-4">Filtrar por Categoria do Material:</span>
                                <select class="px-3 py-1 rounded-md text-sm bg-secondary-bg text-text-primary border border-border-color focus:ring-accent-main focus:border-accent-main" id="materialCategoryFilter">
                                    <option value="Todos">Todos</option>
                                    <!-- Options populated by JS -->
                                </select>
                                <button class="px-3 py-1 rounded-md text-sm" id="filterAllItems">
                                    Todos os Filtros
                                </button>
                            </div>
                            <div class="table-container mt-4">
                                <table class="min-w-full divide-y divide-border-color rounded-lg overflow-hidden" id="dataTable">
                                    <thead class="bg-border-color">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="FICHA">Ficha <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="DESCRICAO_MATERIAL">Descri√ß√£o <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="CONCEITO">Categ. ABC <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="CATEGORIA_MATERIAL">Categ. Material <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="PRECO_MEDIO">Pre√ßo M√©dio <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 whitespace-nowrap text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="ESTOQUE_ATUAL">Estoque <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 whitespace-nowrap text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable" data-column="SITUACAO_ESTOQUE">Situa√ß√£o <span class="sort-icon"></span></th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-secondary-bg divide-y divide-border-color" id="tableBody">
                                        <!-- Items will be loaded here, or skeleton loading -->
                                    </tbody>
                                </table>
                                <div id="tableSkeleton" class="hidden">
                                    <div class="skeleton-loading h-10 w-full mb-2"></div>
                                    <div class="skeleton-loading h-10 w-full mb-2"></div>
                                    <div class="skeleton-loading h-10 w-full mb-2"></div>
                                    <div class="skeleton-loading h-10 w-full mb-2"></div>
                                    <div class="skeleton-loading h-10 w-full mb-2"></div>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <div class="text-sm text-text-secondary">
                                    P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="btn-secondary px-3 py-1 text-sm disabled:opacity-50" disabled="" id="prevPage">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn-secondary px-3 py-1 text-sm disabled:opacity-50" disabled="" id="nextPage">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Priority Items View (NEW COMBINED VIEW) -->
                <div class="hidden" id="priorityItemsView">
                    <!-- Critical Items Section (moved here, previously in inventoryView) -->
                    <section class="mb-8">
                        <div class="border rounded-lg shadow-md p-6 card" style="background-color: var(--status-critical-bg-tint); border-color: var(--status-critical);">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-status-critical flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Itens Cr√≠ticos (Categoria A por Pedidos)
                                </h2>
                                <div class="flex space-x-2">
                                    <button class="btn-secondary text-status-critical px-3 py-1 text-sm" id="exportCriticalExcel">
                                        <i class="fas fa-file-excel mr-1"></i>Excel
                                    </button>
                                    <button class="btn-secondary text-status-critical px-3 py-1 text-sm" id="exportCriticalCSV">
                                        <i class="fas fa-file-csv mr-1"></i>CSV
                                    </button>
                                    <button class="btn-secondary text-status-critical px-3 py-1 text-sm" id="exportCriticalPDF">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                            </div>
                            <p class="text-text-secondary mb-4 leading-relaxed">Os seguintes itens s√£o classificados como **Cr√≠ticos** E pertencem √† **Categoria A** (alta frequ√™ncia de pedidos), exigindo aten√ß√£o imediata:</p>
                            <div class="space-y-3" id="criticalItems">
                                <div class="text-center py-8 hidden" id="noCriticalItemsMessage">
                                    <i class="fas fa-clipboard-check text-border-color text-4xl mb-2"></i>
                                    <p class="text-text-secondary">Nenhum item cr√≠tico de Categoria A identificado</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Alert Items Section (moved here, previously in inventoryView) -->
                    <section class="mb-8">
                        <div class="border rounded-lg shadow-md p-6 card" style="background-color: var(--status-alert-bg-tint); border-color: var(--status-alert);">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-status-alert flex items-center">
                                    <i class="fas fa-bell mr-2"></i>Itens em Alerta
                                </h2>
                                <div class="flex space-x-2">
                                    <button class="btn-secondary text-status-alert px-3 py-1 text-sm" id="exportAlertExcel">
                                        <i class="fas fa-file-excel mr-1"></i>Excel
                                    </button>
                                    <button class="btn-secondary text-status-alert px-3 py-1 text-sm" id="exportAlertCSV">
                                        <i class="fas fa-file-csv mr-1"></i>CSV
                                    </button>
                                    <button class="btn-secondary text-status-alert px-3 py-1 text-sm" id="exportAlertPDF">
                                        <i class="fas fa-file-pdf mr-1"></i>PDF
                                    </button>
                                </div>
                            </div>
                            <p class="text-text-secondary mb-4 leading-relaxed">Os seguintes itens est√£o em **Alerta**, indicando a necessidade de monitoramento:</p>
                            <div class="space-y-3" id="alertItems">
                                <div class="text-center py-8 hidden" id="noAlertItemsMessage">
                                    <i class="fas fa-exclamation-triangle text-border-color text-4xl mb-2"></i>
                                    <p class="text-text-secondary">Nenhum item em Alerta identificado</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>

            <!-- Footer (always visible) -->
            <footer class="bg-secondary-bg text-text-secondary py-6 mt-auto border-t border-border-color">
                <div class="container mx-auto px-4 text-center">
                    <p class="text-sm">¬© 2025 Sistema de An√°lise de Estoque - Curva ABC</p>
                    <p class="text-xs mt-2 text-text-secondary">Cb - Maykon Douglas Soares Pacheco - Data de Pra√ßa: 01/03/2019</p>
                </div>
            </footer>
        </div>

        <!-- Toast Container -->
        <div id="toast-container"></div>

        <!-- Item Detail Modal -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4" id="itemModal">
            <div class="bg-secondary-bg rounded-lg shadow-xl max-w-2xl w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-text-primary" id="modalTitle">Detalhes do Item</h3>
                        <button class="text-text-secondary hover:text-text-primary" id="closeModal">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-text-primary mb-2">Informa√ß√µes B√°sicas</h4>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-text-secondary">Ficha</p>
                                    <p class="font-medium text-text-primary" id="modalFicha"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Descri√ß√£o</p>
                                    <p class="font-medium text-text-primary" id="modalDescricao"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Categoria ABC (por Pedidos)</p>
                                    <p class="font-medium">
                                        <span class="px-2 py-1 rounded text-xs" id="modalConceito"></span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Categoria Material</p>
                                    <p class="font-medium text-text-primary" id="modalCategoriaMaterial"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Pre√ßo M√©dio</p>
                                    <p class="font-medium text-text-primary" id="modalPrecoMedio"></p>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-text-primary mb-2">Movimenta√ß√£o e Estoque</h4>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm text-text-secondary">Sa√≠da Mensal M√©dia</p>
                                        <p class="font-medium text-text-primary" id="modalSaidaMensal"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-text-secondary">Sa√≠das (2 anos)</p>
                                        <p class="font-medium text-text-primary" id="modalSaidas"></p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Estoque Atual</p>
                                    <p class="font-medium text-text-primary" id="modalEstoque"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Situa√ß√£o</p>
                                    <p class="font-medium">
                                        <span class="px-2 py-1 rounded text-xs" id="modalSituacao"></span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-text-secondary">Estoque Ideal (4 Meses)</p>
                                    <p class="font-medium text-text-primary" id="modalEstoqueIdeal"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-medium text-text-primary mb-2">Hist√≥rico de Sa√≠das Mensais</h4>
                        <div class="h-48" id="itemHistoryChart"></div>
                    </div>
                    <!-- Nova se√ß√£o para o Plano de A√ß√£o LLM -->
                    <div class="mt-6 hidden" id="llmActionPlanSection">
                        <h4 class="font-medium text-text-primary mb-2">‚ú® Plano de A√ß√£o Sugerido pela IA</h4>
                        <div class="bg-primary-bg p-4 rounded-md text-text-primary text-sm overflow-auto max-h-48 leading-relaxed" id="llmActionPlanContent">
                            <!-- O plano de a√ß√£o ser√° carregado aqui -->
                        </div>
                        <div class="text-center py-2 hidden text-accent-main" id="llmLoading">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Gerando plano de a√ß√£o...
                        </div>
                        <div class="text-status-critical mt-2 hidden" id="llmError"></div>
                    </div>
                    <!-- NEW: API Integration Conceptual Section -->
                    <div class="mt-6 p-4 rounded-lg bg-primary-bg border border-border-color">
                        <h4 class="font-medium text-text-primary mb-2">Integra√ß√£o com Fornecedores (Conceitual)</h4>
                        <p class="text-sm text-text-secondary mb-3 leading-relaxed">
                            Esta se√ß√£o ilustra como uma integra√ß√£o com APIs de fornecedores poderia funcionar.
                            Em um sistema real, poder√≠amos consultar o estoque do fornecedor ou automatizar pedidos.
                        </p>
                        <button class="btn-secondary text-sm" id="simulateApiCallBtn">
                            <i class="fas fa-external-link-alt mr-2"></i>Consultar Fornecedor (API Simulado)
                        </button>
                        <div class="mt-3 p-3 rounded-md text-text-primary text-sm hidden leading-relaxed" id="apiSimulationResult" style="background-color: var(--secondary-bg);">
                            <!-- Simulated API response will appear here -->
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="btn-primary hidden" id="generateActionPlanBtn">
                            <i class="fas fa-brain mr-2"></i>‚ú® Gerar Plano de A√ß√£o
                        </button>
                        <button class="btn-primary" id="editItemBtn">
                            <i class="fas fa-edit mr-2"></i>Editar Item
                        </button>
                        <button class="btn-secondary text-status-critical" id="deleteItemModalBtn">
                            <i class="fas fa-trash-alt mr-2"></i>Excluir Item
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Form Modal (Add/Edit) -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4" id="itemFormModal">
            <div class="bg-secondary-bg rounded-lg shadow-xl max-w-md w-full" data-mode="add">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-text-primary" id="itemFormModalTitle">Adicionar Novo Item</h3>
                        <button class="text-text-secondary hover:text-text-primary" id="closeItemFormModal">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                    <!-- Error messages for form fields -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formFicha">Ficha</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formFicha" type="text" autofocus/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorFicha"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formDescricao">Descri√ß√£o</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formDescricao" type="text"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorDescricao"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formContagem">Contagem Inicial</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formContagem" type="number"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorContagem"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formSaidas">Sa√≠das (2 anos)</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formSaidas" type="number"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorSaidas"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formPrecoMedio">Pre√ßo M√©dio Unit√°rio</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formPrecoMedio" type="number"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorPrecoMedio"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formEstoqueAtual">Estoque Atual</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formEstoqueAtual" type="number"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorEstoqueAtual"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-primary" for="formPlanejamento4Meses">Planejamento Pr√≥x. 4 Meses</label>
                            <input class="mt-1 block w-full border border-border-color rounded-md shadow-sm p-2 focus:ring-2 focus:ring-accent-main focus:border-accent-main" id="formPlanejamento4Meses" type="number"/>
                            <p class="text-status-critical text-xs mt-1 hidden" id="errorPlanejamento4Meses"></p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button class="btn-secondary" id="cancelItemFormBtn">Cancelar</button>
                        <button class="btn-primary" id="saveItemFormBtn">Salvar Item</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal (for delete) -->
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4" id="confirmationModal">
            <div class="bg-secondary-bg rounded-lg shadow-xl max-w-sm w-full">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-text-primary mb-4">Confirmar Exclus√£o</h3>
                    <p class="text-text-secondary mb-6 leading-relaxed" id="confirmationMessage">Tem certeza de que deseja excluir este item?</p>
                    <div class="flex justify-end space-x-3">
                        <button class="btn-secondary" id="cancelDeleteBtn">Cancelar</button>
                        <button class="btn-primary bg-status-critical hover:bg-red-700" id="confirmDeleteBtn">Excluir</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Sample data for demonstration, now with PRECO_MEDIO and adjusted SITUACAO_ESTOQUE logic
        const sampleData = [
            { "FICHA": "MAT001", "DESCRICAO_MATERIAL": "Uniforme Camuflado - Tamanho M", "CONTAGEM": 150, "SAIDAS": 245, "PRECO_MEDIO": 20.00, "ESTOQUE_ATUAL": 35, "PLANEJAMENTO_4_MESES": 80, "CATEGORIA_MATERIAL": "Vestu√°rio" },
            { "FICHA": "MAT002", "DESCRICAO_MATERIAL": "Bota de Campo - N¬∫ 42", "CONTAGEM": 120, "SAIDAS": 180, "PRECO_MEDIO": 15.00, "ESTOQUE_ATUAL": 10, "PLANEJAMENTO_4_MESES": 60, "CATEGORIA_MATERIAL": "Cal√ßados" }, /* Critical */
            { "FICHA": "MAT003", "DESCRICAO_MATERIAL": "Capacete Militar - Padr√£o", "CONTAGEM": 85, "SAIDAS": 110, "PRECO_MEDIO": 9.00, "ESTOQUE_ATUAL": 15, "PLANEJAMENTO_4_MESES": 36, "CATEGORIA_MATERIAL": "Equipamento Prote√ß√£o" }, /* Alert */
            { "FICHA": "MAT004", "DESCRICAO_MATERIAL": "Cinto T√°tico - Preto", "CONTAGEM": 200, "SAIDAS": 310, "PRECO_MEDIO": 25.00, "ESTOQUE_ATUAL": 65, "PLANEJAMENTO_4_MESES": 100, "CATEGORIA_MATERIAL": "Acess√≥rios" }, /* Normal */
            { "FICHA": "MAT005", "DESCRICAO_MATERIAL": "Luvas T√°ticas - Par", "CONTAGEM": 300, "SAIDAS": 420, "PRECO_MEDIO": 35.00, "ESTOQUE_ATUAL": 95, "PLANEJAMENTO_4_MESES": 140, "CATEGORIA_MATERIAL": "Acess√≥rios" },
            { "FICHA": "MAT006", "DESCRICAO_MATERIAL": "Mochila T√°tica - 30L", "CONTAGEM": 60, "SAIDAS": 45, "PRECO_MEDIO": 4.00, "ESTOQUE_ATUAL": 22, "PLANEJAMENTO_4_MESES": 16, "CATEGORIA_MATERIAL": "Equipamento T√°tico" },
            { "FICHA": "MAT007", "DESCRICAO_MATERIAL": "Garrafa de √Ågua - 1L", "CONTAGEM": 500, "SAIDAS": 680, "PRECO_MEDIO": 55.00, "ESTOQUE_ATUAL": 120, "PLANEJAMENTO_4_MESES": 220, "CATEGORIA_MATERIAL": "Utilidades" },
            { "FICHA": "MAT010", "DESCRICAO_MATERIAL": "Canivete Multiuso - A√ßo Inox", "CONTAGEM": 400, "SAIDAS": 520, "PRECO_MEDIO": 42.00, "ESTOQUE_ATUAL": 95, "PLANEJAMENTO_4_MESES": 168, "CATEGORIA_MATERIAL": "Ferramentas" },
            { "FICHA": "MAT011", "DESCRICAO_MATERIAL": "R√°dio Comunicador Port√°til", "CONTAGEM": 50, "SAIDAS": 60, "PRECO_MEDIO": 120.00, "ESTOQUE_ATUAL": 5, "PLANEJAMENTO_4_MESES": 20, "CATEGORIA_MATERIAL": "Eletr√¥nicos" },
            { "FICHA": "MAT012", "DESCRICAO_MATERIAL": "Barraca de Acampamento Individual", "CONTAGEM": 30, "SAIDAS": 25, "PRECO_MEDIO": 80.00, "ESTOQUE_ATUAL": 10, "PLANEJAMENTO_4_MESES": 10, "CATEGORIA_MATERIAL": "Acampamento" },
            { "FICHA": "MAT013", "DESCRICAO_MATERIAL": "Corda de Escalada - 50m", "CONTAGEM": 20, "SAIDAS": 18, "PRECO_MEDIO": 70.00, "ESTOQUE_ATUAL": 8, "PLANEJAMENTO_4_MESES": 8, "CATEGORIA_MATERIAL": "Equipamento Escalada" },
            { "FICHA": "MAT014", "DESCRICAO_MATERIAL": "√ìculos de Prote√ß√£o Bal√≠stica", "CONTAGEM": 100, "SAIDAS": 130, "PRECO_MEDIO": 30.00, "ESTOQUE_ATUAL": 20, "PLANEJAMENTO_4_MESES": 40, "CATEGORIA_MATERIAL": "Equipamento Prote√ß√£o" },
            { "FICHA": "MAT015", "DESCRICAO_MATERIAL": "B√∫ssola Profissional", "CONTAGEM": 70, "SAIDAS": 80, "PRECO_MEDIO": 12.00, "ESTOQUE_ATUAL": 12, "PLANEJAMENTO_4_MESES": 25, "CATEGORIA_MATERIAL": "Navega√ß√£o" },
            { "FICHA": "MAT016", "DESCRICAO_MATERIAL": "Kit de Sobreviv√™ncia", "CONTAGEM": 40, "SAIDAS": 30, "PRECO_MEDIO": 90.00, "ESTOQUE_ATUAL": 15, "PLANEJAMENTO_4_MESES": 12, "CATEGORIA_MATERIAL": "Equipamento T√°tico" },
            { "FICHA": "MAT017", "DESCRICAO_MATERIAL": "Farda de Gala", "CONTAGEM": 25, "SAIDAS": 10, "PRECO_MEDIO": 250.00, "ESTOQUE_ATUAL": 20, "PLANEJAMENTO_4_MESES": 4, "CATEGORIA_MATERIAL": "Vestu√°rio Especial" },
            { "FICHA": "MAT018", "DESCRICAO_MATERIAL": "GPS T√°tico", "CONTAGEM": 15, "SAIDAS": 8, "PRECO_MEDIO": 300.00, "ESTOQUE_ATUAL": 5, "PLANEJAMENTO_4_MESES": 3, "CATEGORIA_MATERIAL": "Eletr√¥nicos" },
            { "FICHA": "MAT019", "DESCRICAO_MATERIAL": "Bin√≥culos Militares", "CONTAGEM": 30, "SAIDAS": 20, "PRECO_MEDIO": 180.00, "ESTOQUE_ATUAL": 10, "PLANEJAMENTO_4_MESES": 8, "CATEGORIA_MATERIAL": "√ìptica" },
            { "FICHA": "MAT020", "DESCRICAO_MATERIAL": "Ra√ß√£o de Combate (Unidade)", "CONTAGEM": 500, "SAIDAS": 400, "PRECO_MEDIO": 5.00, "ESTOQUE_ATUAL": 100, "PLANEJAMENTO_4_MESES": 150, "CATEGORIA_MATERIAL": "Alimentos" }
        ];

        // Main application state and methods
        const App = {
            inventoryData: [],
            filteredData: [],
            currentPage: 1,
            itemsPerPage: 10,
            sortColumn: 'FICHA',
            sortDirection: 'asc',
            currentABCFilter: 'Todos',
            currentStockSituationFilter: 'Todos',
            currentMaterialCategoryFilter: 'Todos',
            abcChartMaterialFilter: 'Todos',
            stockChartMaterialFilter: 'Todos',
            // Changed to array to hold multiple selected categories for comparative mode
            representativenessDonutChartMaterialFilter: [],
            consumptionMaterialCategoryFilter: [],
            stockVsConsumptionMaterialCategoryFilter: [],
            importTimestamp: null,
            currentItemForLLM: null,
            itemToDeleteFicha: null,
            currentView: 'home',
            currentItemBeingEdited: null, // Track item being edited in form modal

            // Define expected column names and their possible aliases for robust parsing
            expectedColumns: {
                "FICHA": ["FICHA", "Ficha", "ID", "Codigo", "C√ìDIGO", "SKU"],
                "DESCRICAO_MATERIAL": ["DESCRICAO_MATERIAL", "Descricao Material", "DESCRI√á√ÉO", "MATERIAL", "Item"],
                "CONTAGEM": ["CONTAGEM", "Contagem Inicial", "In√≠cio", "Invent√°rio Inicial", "Pedidos", "Frequ√™ncia", "Contagem Pedidos"], // Added aliases for CONTAGEM
                "SAIDAS": ["SAIDAS", "Sa√≠das (2 anos)", "Vendas_2_anos", "Consumo"], // Optional
                "PRECO_MEDIO": ["PRECO_MEDIO", "Pre√ßo M√©dio", "Preco Medio", "Custo M√©dio, Custo Medio", "Valor Unit√°rio"],
                "ESTOQUE_ATUAL": ["ESTOQUE_ATUAL", "Estoque Atual", "Qtd Estoque", "Quantidade Atual"],
                "PLANEJAMENTO_4_MESES": ["PLANEJAMENTO_4_MESES", "Planejamento 4 Meses", "Previs√£o 4 Meses"], // Optional
                "CATEGORIA_MATERIAL": ["CATEGORIA_MATERIAL", "Categoria Material", "Categoria", "Tipo Material"] // Optional column for material category
            },

            /**
             * Formats a numeric value as Brazilian Real currency.
             * @param {number} value - The number to format.
             * @returns {string} The formatted currency string.
             */
            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            },

            /**
             * Formats a numeric value with a compact notation (e.g., 1000 -> 1k).
             * @param {number} value - The number to format.
             * @returns {string} The formatted string.
             */
            formatCompactNumber(value) {
                if (value >= 1000) {
                    return (value / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
                }
                return value.toString();
            },

            /**
             * Formats a timestamp into a localized date and time string.
             * @param {number} timestamp - The timestamp to format.
             * @returns {string} The formatted date string.
             */
            formatDate(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            },

            /**
             * Maps column names from an uploaded file to expected system names.
             * @param {string[]} headers - Array of headers from the uploaded file.
             * @returns {{mappedHeaders: Object, missingRequired: string[]}} An object containing mapped headers and a list of missing required headers.
             */
            mapColumns(headers) {
                const mappedHeaders = {};
                const missingRequired = [];
                // Updated mandatory keys to include CONTAGEM
                const mandatoryKeys = ["FICHA", "DESCRICAO_MATERIAL", "PRECO_MEDIO", "ESTOQUE_ATUAL", "CONTAGEM"];

                for (const key in this.expectedColumns) {
                    const aliases = this.expectedColumns[key].map(alias => alias.toLowerCase());
                    const foundHeader = headers.find(header => aliases.includes(header.toLowerCase()));
                    if (foundHeader) {
                        mappedHeaders[key] = foundHeader; // Store the actual header name from the file
                    } else if (mandatoryKeys.includes(key)) {
                        missingRequired.push(key);
                    }
                }
                return { mappedHeaders, missingRequired };
            },

            /**
             * Loads and processes inventory data.
             * @param {Array<Object>} data - The raw data to load.
             */
            async loadData(data) {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('columnError').classList.add('hidden'); // Clear previous errors

                if (data.length === 0) {
                    document.getElementById('columnError').textContent = "O arquivo est√° vazio ou n√£o cont√©m dados.";
                    document.getElementById('columnError').classList.remove('hidden');
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    App.showToast('O arquivo est√° vazio ou n√£o cont√©m dados.', 'error');
                    return;
                }

                const fileHeaders = Object.keys(data[0]);
                const { mappedHeaders, missingRequired } = this.mapColumns(fileHeaders);

                if (missingRequired.length > 0) {
                    const missingColsNames = missingRequired.map(key => this.expectedColumns[key][0]).join(', ');
                    document.getElementById('columnError').innerHTML = `Erro: Colunas essenciais n√£o encontradas: <strong>${missingColsNames}</strong>. Por favor, verifique se o arquivo possui as colunas corretas ou seus sin√≥nimos.`;
                    document.getElementById('columnError').classList.remove('hidden');
                    document.getElementById('loadingIndicator').classList.add('hidden');
                    this.inventoryData = []; // Clear data if parsing failed
                    this.updateUI();
                    App.showToast(`Erro: Colunas essenciais n√£o encontradas: ${missingColsNames}`, 'error');
                    return;
                }

                this.inventoryData = data.map(item => {
                    const processedItem = {};
                    processedItem.FICHA = String(item[mappedHeaders.FICHA] || '');
                    processedItem.DESCRICAO_MATERIAL = String(item[mappedHeaders.DESCRICAO_MATERIAL] || '');
                    processedItem.CONTAGEM = parseFloat(item[mappedHeaders.CONTAGEM] || 0) || 0; // Ensure CONTAGEM is parsed as a number
                    processedItem.SAIDAS = parseFloat(item[mappedHeaders.SAIDAS] || 0) || 0;
                    processedItem.PRECO_MEDIO = parseFloat(item[mappedHeaders.PRECO_MEDIO] || 0) || 0;
                    processedItem.ESTOQUE_ATUAL = parseFloat(item[mappedHeaders.ESTOQUE_ATUAL] || 0) || 0;
                    processedItem.PLANEJAMENTO_4_MESES = parseFloat(item[mappedHeaders.PLANEJAMENTO_4_MESES] || 0) || 0;
                    processedItem.CATEGORIA_MATERIAL = String(item[mappedHeaders.CATEGORIA_MATERIAL] || 'Outros');

                    processedItem.VALOR_TOTAL_ITEM = processedItem.PRECO_MEDIO * processedItem.ESTOQUE_ATUAL;

                    const SAIDAS_MENSAIS = processedItem.SAIDAS / 24;
                    processedItem.SAIDAS_ANUAL = processedItem.SAIDAS / 2; // Calculate annual consumption

                    if (SAIDAS_MENSAIS > 0) {
                        if (processedItem.ESTOQUE_ATUAL < SAIDAS_MENSAIS) {
                            processedItem.SITUACAO_ESTOQUE = "Cr√≠tico";
                        } else if (processedItem.ESTOQUE_ATUAL < (2 * SAIDAS_MENSAIS)) {
                            processedItem.SITUACAO_ESTOQUE = "Alerta";
                        } else {
                            processedItem.SITUACAO_ESTOQUE = "Normal";
                        }
                    } else {
                        processedItem.SITUACAO_ESTOQUE = "Normal";
                    }

                    processedItem.SAIDAS_MENSAIS = SAIDAS_MENSAIS;
                    processedItem.ESTOQUE_IDEAL = 4 * SAIDAS_MENSAIS;
                    processedItem.CONCEITO = ''; // Will be assigned by runABCAnalysis
                    return processedItem;
                });

                this.runABCAnalysis(); // Now based on CONTAGEM
                this.runSegmentedABCAnalysis(); // This one also needs to be updated or removed if not needed for CONTAGEM
                this.populateMaterialCategoriesFilters();

                // Initialize multi-select filters with all categories selected by default
                const allCategories = Array.from(new Set(this.inventoryData.map(item => item.CATEGORIA_MATERIAL || 'Outros'))).sort();
                this.representativenessDonutChartMaterialFilter = [...allCategories];
                this.consumptionMaterialCategoryFilter = [...allCategories];
                this.stockVsConsumptionMaterialCategoryFilter = [...allCategories];

                this.applyFilters();
                this.updateUI();
                this.importTimestamp = Date.now();
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('importDate').textContent = `(Importado em: ${this.formatDate(this.importTimestamp)})`;
                document.getElementById('fileInfo').classList.remove('hidden');
                this.saveToLocalStorage();

                App.showToast('Dados carregados com sucesso!', 'success');
            },

            /**
             * Performs ABC analysis on the inventory data based on CONTAGEM.
             */
            runABCAnalysis() {
                // Sort items by CONTAGEM in descending order
                const sortedItems = [...this.inventoryData].sort((a, b) => b.CONTAGEM - a.CONTAGEM);
                // Calculate total CONTAGEM for all items
                let totalContagem = sortedItems.reduce((sum, item) => sum + item.CONTAGEM, 0);
                let cumulativeContagem = 0;
                const updatedConcepts = new Map();

                for (let i = 0; i < sortedItems.length; i++) {
                    cumulativeContagem += sortedItems[i].CONTAGEM;
                    const cumulativePercentage = (cumulativeContagem / totalContagem) * 100;

                    let concept = '';
                    if (cumulativePercentage <= 80) {
                        concept = 'A'; // Top 80% by order count
                    } else if (cumulativePercentage <= 95) {
                        concept = 'B'; // Next 15% by order count
                    } else {
                        concept = 'C'; // Last 5% by order count
                    }
                    updatedConcepts.set(sortedItems[i].FICHA, concept);
                }

                this.inventoryData = this.inventoryData.map(item => ({
                    ...item,
                    CONCEITO: updatedConcepts.get(item.FICHA) || item.CONCEITO
                }));
            },

            /**
             * Performs ABC analysis segmented by material category (still based on VALOR_TOTAL_ITEM for now, as per user's request to only change the main ABC).
             * If the user wants segmented ABC by CONTAGEM, this function would need similar changes to runABCAnalysis.
             */
            runSegmentedABCAnalysis() {
                const groupedItems = {};
                this.inventoryData.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    if (!groupedItems[category]) {
                        groupedItems[category] = [];
                    }
                    groupedItems[category].push(item);
                });

                for (const categoryName in groupedItems) {
                    const itemsInCategory = groupedItems[categoryName];
                    if (itemsInCategory.length === 0) continue;

                    // This part still uses VALOR_TOTAL_ITEM. If segmented ABC by CONTAGEM is desired, change this line.
                    let totalValueCategory = itemsInCategory.reduce((sum, item) => sum + item.VALOR_TOTAL_ITEM, 0);
                    itemsInCategory.sort((a, b) => b.VALOR_TOTAL_ITEM - a.VALOR_TOTAL_ITEM);

                    let accumulatedValue = 0;
                    itemsInCategory.forEach(item => {
                        accumulatedValue += item.VALOR_TOTAL_ITEM;
                        const cumulativePercentage = (accumulatedValue / totalValueCategory) * 100;

                        if (cumulativePercentage <= 80) {
                            item.CONCEITO_SEGMENTADO = 'A';
                        } else if (cumulativePercentage <= 95) {
                            item.CONCEITO_SEGMENTADO = 'B';
                        } else {
                            item.CONCEITO_SEGMENTADO = 'C';
                        }
                    });
                }
            },

            /**
             * Updates the UI based on the current view.
             */
            updateUI() {
                if (this.currentView === 'inventory') {
                    if (this.inventoryData.length === 0) {
                        document.getElementById('emptyState').classList.remove('hidden');
                        document.getElementById('dashboardSection').classList.add('hidden');
                    } else {
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('dashboardSection').classList.remove('hidden');
                    }
                    this.updateDashboard();
                    this.renderCharts();
                } else if (this.currentView === 'allItems') {
                    this.renderTable();
                } else if (this.currentView === 'priorityItems') {
                    this.renderPriorityItems();
                }
            },

            /**
             * Updates the dashboard metrics.
             */
            updateDashboard() {
                const totalItems = this.inventoryData.length;
                const totalStockValue = this.inventoryData.reduce((sum, item) => sum + item.VALOR_TOTAL_ITEM, 0);

                const countAVal = this.inventoryData.filter(item => item.CONCEITO === 'A').length;
                const countBVal = this.inventoryData.filter(item => item.CONCEITO === 'B').length;
                const countCVal = this.inventoryData.filter(item => item.CONCEITO === 'C').length;

                const countCriticalVal = this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Cr√≠tico').length;
                const countAlertVal = this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Alerta').length;
                const countNormalVal = this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Normal').length;

                document.getElementById('totalStockValue').textContent = this.formatCurrency(totalStockValue);
                document.getElementById('totalItemsCount').textContent = totalItems;

                document.getElementById('countA').textContent = countAVal;
                document.getElementById('percentA').textContent = totalItems > 0 ? `(${((countAVal / totalItems) * 100).toFixed(1)}%)` : '';
                document.getElementById('countB').textContent = countBVal;
                document.getElementById('percentB').textContent = totalItems > 0 ? `(${((countBVal / totalItems) * 100).toFixed(1)}%)` : '';
                document.getElementById('countC').textContent = countCVal;
                document.getElementById('percentC').textContent = totalItems > 0 ? `(${((countCVal / totalItems) * 100).toFixed(1)}%)` : '';

                document.getElementById('countCritical').textContent = countCriticalVal;
                document.getElementById('percentCritical').textContent = totalItems > 0 ? `(${((countCriticalVal / totalItems) * 100).toFixed(1)}%)` : '';
                document.getElementById('countAlert').textContent = countAlertVal;
                document.getElementById('percentAlert').textContent = totalItems > 0 ? `(${((countAlertVal / totalItems) * 100).toFixed(1)}%)` : '';
                document.getElementById('countNormal').textContent = countNormalVal;
                document.getElementById('percentNormal').textContent = totalItems > 0 ? `(${((countNormalVal / totalItems) * 100).toFixed(1)}%)` : '';
            },

            /**
             * Renders all charts.
             */
            renderCharts() {
                this.drawABCChart(this.abcChartMaterialFilter);
                this.drawStockChart(this.stockChartMaterialFilter);
                this.drawMaterialCategoryChart();
                // Pass the array of selected categories
                this.drawRepresentativenessDonutChart(this.representativenessDonutChartMaterialFilter);
                this.drawConsumptionByMaterialCategoryChart(this.consumptionMaterialCategoryFilter);
                this.drawStockConsumptionStackedBarChart(this.stockVsConsumptionMaterialCategoryFilter); // Updated function call
            },

            /**
             * Draws the ABC analysis donut chart (now based on CONTAGEM).
             * @param {string} materialCategoryFilter - Filter by material category.
             */
            drawABCChart(materialCategoryFilter = 'Todos') {
                let dataToChart = this.inventoryData;
                if (materialCategoryFilter !== 'Todos') {
                    dataToChart = this.inventoryData.filter(item => item.CATEGORIA_MATERIAL === materialCategoryFilter);
                }

                const countA = dataToChart.filter(item => item.CONCEITO === 'A').length;
                const countB = dataToChart.filter(item => item.CONCEITO === 'B').length;
                const countC = dataToChart.filter(item => item.CONCEITO === 'C').length;
                const totalItems = dataToChart.length;

                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const accentMain = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();

                // Determine text color for data labels based on dark mode
                const isDarkMode = document.body.classList.contains('dark-mode');
                const dataLabelTextColor = isDarkMode ? '#FFFFFF' : '#000000'; // White for dark, black for light

                const data = [{
                    values: [countA, countB, countC],
                    labels: ['Categoria A', 'Categoria B', 'Categoria C'],
                    type: 'pie',
                    hole: 0.6,
                    hoverinfo: 'label+text',
                    textinfo: 'percent',
                    text: [
                        `Categoria A: ${countA} itens`,
                        `Categoria B: ${countB} itens`,
                        `Categoria C: ${countC} itens`
                    ],
                    marker: {
                        colors: [
                            getComputedStyle(document.documentElement).getPropertyValue('--abc-a-color').trim(),
                            getComputedStyle(document.documentElement).getPropertyValue('--abc-b-color').trim(),
                            getComputedStyle(document.documentElement).getPropertyValue('--abc-c-color').trim()
                        ],
                        line: {
                            color: secondaryBgColor,
                            width: 2
                        }
                    },
                    textfont: {
                        color: dataLabelTextColor, // Dynamically adapt to theme's primary text color
                        size: 12,
                        weight: 'bold'
                    },
                    pull: [0.03, 0, 0]
                }];

                const layout = {
                    autosize: true,
                    height: 384,
                    margin: { t: 50, b: 20, l: 20, r: 20 },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: -0.2,
                        xanchor: 'center',
                        x: 0.5,
                        font: {
                            color: textColor,
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    annotations: [{
                        font: {
                            size: 20,
                            color: accentMain,
                            weight: 'bold'
                        },
                        showarrow: false,
                        text: `${totalItems}<br>Itens`,
                        x: 0.5,
                        y: 0.5
                    }],
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: {
                            color: textColor
                        },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        namelength: -1
                    },
                    font: {
                        family: 'Inter',
                        color: textColor
                    }
                };
                Plotly.react('abcChart', data, layout, { responsive: true, displayModeBar: false });
            },

            /**
             * Draws the stock situation line chart.
             * @param {string} materialCategoryFilter - Filter by material category.
             */
            drawStockChart(materialCategoryFilter = 'Todos') {
                let dataToChart = this.inventoryData;
                if (materialCategoryFilter !== 'Todos') {
                    dataToChart = this.inventoryData.filter(item => item.CATEGORIA_MATERIAL === materialCategoryFilter);
                }

                const stockSituations = { Cr√≠tico: 0, Alerta: 0, Normal: 0 };
                dataToChart.forEach(item => {
                    if (stockSituations[item.SITUACAO_ESTOQUE] !== undefined) {
                        stockSituations[item.SITUACAO_ESTOQUE]++;
                    }
                });

                const colorCritical = getComputedStyle(document.documentElement).getPropertyValue('--status-critical').trim();
                const colorAlert = getComputedStyle(document.documentElement).getPropertyValue('--status-alert').trim();
                const colorNormal = getComputedStyle(document.documentElement).getPropertyValue('--status-normal').trim();
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();

                const data = [{
                    x: ['Cr√≠tico', 'Alerta', 'Normal'],
                    y: [stockSituations.Cr√≠tico, stockSituations.Alerta, stockSituations.Normal],
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: {
                        color: [colorCritical, colorAlert, colorNormal],
                        size: 10,
                        line: {
                            color: secondaryBgColor,
                            width: 1.5
                        }
                    },
                    line: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim(),
                        width: 3,
                        shape: 'spline'
                    },
                    hoverinfo: 'x+y',
                    hovertemplate: '<b>Situa√ß√£o:</b> %{x}<br><b>Itens:</b> %{y}<extra></extra>'
                }];

                const layout = {
                    autosize: true,
                    height: 384,
                    margin: { t: 60, b: 50, l: 50, r: 30 },
                    title: {
                        text: 'Situa√ß√£o do Estoque (N√∫mero de Itens)',
                        font: {
                            color: textColor,
                            size: 18,
                            weight: 'bold'
                        },
                        yref: 'paper',
                        y: 0.95
                    },
                    xaxis: {
                        title: {
                            text: 'Situa√ß√£o do Estoque',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        categoryorder: 'array',
                        categoryarray: ['Cr√≠tico', 'Alerta', 'Normal'],
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'N√∫mero de Itens',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        tickformat: ',.0s',
                        automargin: true
                    },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    font: {
                        color: textColor,
                        family: 'Inter',
                    },
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: { color: textColor },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim(),
                        namelength: -1
                    },
                    showlegend: false
                };
                Plotly.react('stockChart', data, layout, { responsive: true, displayModeBar: false });
            },

            /**
             * Draws the material category horizontal bar chart.
             */
            drawMaterialCategoryChart() {
                const categoryData = {};
                this.inventoryData.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    if (!categoryData[category]) {
                        categoryData[category] = { count: 0, value: 0 };
                    }
                    categoryData[category].count++;
                    categoryData[category].value += item.VALOR_TOTAL_ITEM;
                });

                const sortedCategories = Object.entries(categoryData).sort(([, dataA], [, dataB]) => dataA.count - dataB.count);

                const categories = sortedCategories.map(([category]) => category);
                const counts = sortedCategories.map(([, data]) => data.count);

                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const accentMain = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();

                const data = [{
                    x: counts,
                    y: categories,
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: accentMain,
                        line: {
                            color: secondaryBgColor,
                            width: 1.5
                        }
                    },
                    hoverinfo: 'text',
                    text: counts.map((count, index) => {
                        const totalItems = this.inventoryData.length;
                        const percent = totalItems > 0 ? ((count / totalItems) * 100).toFixed(1) : 0;
                        return `${count} itens (${percent}%)`;
                    }),
                    textposition: 'inside',
                    textfont: {
                        color: primaryBgColor,
                        size: 12,
                        weight: 'bold'
                    },
                    insidetextanchor: 'end'
                }];

                const layout = {
                    autosize: true,
                    height: Math.max(384, categories.length * 40 + 100),
                    margin: { t: 50, b: 50, l: 150, r: 80 },
                    xaxis: {
                        title: {
                            text: 'N√∫mero de Itens',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        showgrid: true,
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Categoria de Material',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        showgrid: true,
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        automargin: true
                    },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    font: {
                        color: textColor,
                        family: 'Inter',
                    },
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: { color: textColor },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim(),
                        namelength: -1
                    },
                    bargap: 0.1
                };
                Plotly.react('materialCategoryChart', data, layout, { responsive: true, displayModeBar: false });
            },

            /**
             * Draws the new representativeness donut chart for Material Categories based on total item value, with material category filter.
             * @param {string[]} selectedCategories - Array of selected material categories.
             */
            drawRepresentativenessDonutChart(selectedCategories) {
                let dataToChart = this.inventoryData;
                if (selectedCategories && selectedCategories.length > 0) {
                    dataToChart = dataToChart.filter(item => selectedCategories.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryValues = {};
                dataToChart.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    categoryValues[category] = (categoryValues[category] || 0) + item.VALOR_TOTAL_ITEM;
                });

                const totalValueFiltered = Object.values(categoryValues).reduce((sum, val) => sum + val, 0);

                const labels = Object.keys(categoryValues);
                const values = Object.values(categoryValues);

                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();

                // Determine text color for data labels based on dark mode
                const isDarkMode = document.body.classList.contains('dark-mode');
                const dataLabelTextColor = isDarkMode ? '#FFFFFF' : '#000000'; // White for dark, black for light

                // Generate a consistent color palette for material categories
                const materialCategoryColors = [
                    '#4C78A8', '#F58518', '#E45756', '#72B7B2', '#54A24B',
                    '#EECA3B', '#B279A2', '#FF9DA7', '#9D755D', '#BAB0AC'
                ];
                const colors = labels.map((_, index) => materialCategoryColors[index % materialCategoryColors.length]);

                const data = [{
                    values: values,
                    labels: labels,
                    type: 'pie',
                    hole: 0.6,
                    hoverinfo: 'label+text',
                    textinfo: 'percent',
                    text: labels.map((label, index) => `${label}: ${this.formatCurrency(values[index])}`),
                    marker: {
                        colors: colors,
                        line: {
                            color: secondaryBgColor,
                            width: 2
                        }
                    },
                    textfont: {
                        color: dataLabelTextColor, // Dynamically adapt to theme's primary text color
                        size: 12,
                        weight: 'bold'
                    },
                    pull: [0.03, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }];

                const layout = {
                    autosize: true,
                    height: 450,
                    margin: { t: 30, b: 20, l: 20, r: 20 }, // Reduced top margin as Plotly title is removed
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: -0.2,
                        xanchor: 'center',
                        x: 0.5,
                        font: {
                            color: textColor,
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    annotations: [], // Removed total value annotation from center
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: {
                            color: textColor
                        },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        namelength: -1
                    },
                    font: {
                        family: 'Inter',
                        color: textColor
                    }
                };
                Plotly.react('representativenessDonutChart', data, layout, { responsive: true, displayModeBar: false });

                // Update the external total value display
                document.getElementById('representativenessTotalValue').textContent = this.formatCurrency(totalValueFiltered);
            },

            /**
             * NEW: Draws the annual consumption by material category donut chart.
             * @param {string[]} selectedCategories - Array of selected material categories.
             */
            drawConsumptionByMaterialCategoryChart(selectedCategories) {
                let dataToChart = this.inventoryData;
                if (selectedCategories && selectedCategories.length > 0) {
                    dataToChart = dataToChart.filter(item => selectedCategories.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryConsumptionMonetary = {};
                dataToChart.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    // Calculate monetary value: Annual Consumption (units) * Average Price
                    categoryConsumptionMonetary[category] = (categoryConsumptionMonetary[category] || 0) + (item.SAIDAS_ANUAL * item.PRECO_MEDIO);
                });

                const totalConsumptionMonetaryFiltered = Object.values(categoryConsumptionMonetary).reduce((sum, val) => sum + val, 0);

                const labels = Object.keys(categoryConsumptionMonetary);
                const values = Object.values(categoryConsumptionMonetary);

                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();

                // Determine text color for data labels based on dark mode
                const isDarkMode = document.body.classList.contains('dark-mode');
                const dataLabelTextColor = isDarkMode ? '#FFFFFF' : '#000000'; // White for dark, black for light

                // Generate a consistent color palette for material categories
                const materialCategoryColors = [
                    '#4C78A8', '#F58518', '#E45756', '#72B7B2', '#54A24B',
                    '#EECA3B', '#B279A2', '#FF9DA7', '#9D755D', '#BAB0AC'
                ];
                const colors = labels.map((_, index) => materialCategoryColors[index % materialCategoryColors.length]);

                const data = [{
                    values: values,
                    labels: labels,
                    type: 'pie',
                    hole: 0.6,
                    hoverinfo: 'label+text',
                    textinfo: 'percent',
                    text: labels.map((label, index) => `${label}: ${this.formatCurrency(values[index])}`),
                    marker: {
                        colors: colors,
                        line: {
                            color: secondaryBgColor,
                            width: 2
                        }
                    },
                    textfont: {
                        color: dataLabelTextColor,
                        size: 12,
                        weight: 'bold'
                    },
                    pull: [0.03, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                }];

                const layout = {
                    autosize: true,
                    height: 450,
                    margin: { t: 30, b: 20, l: 20, r: 20 },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: -0.2,
                        xanchor: 'center',
                        x: 0.5,
                        font: {
                            color: textColor,
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    annotations: [],
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: {
                            color: textColor
                        },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        namelength: -1
                    },
                    font: {
                        family: 'Inter',
                        color: textColor
                    }
                };
                Plotly.react('consumptionMaterialCategoryChart', data, layout, { responsive: true, displayModeBar: false });

                document.getElementById('consumptionTotalValue').textContent = this.formatCurrency(totalConsumptionMonetaryFiltered);
            },

            /**
             * NEW: Draws the 100% stacked bar chart of current stock vs. annual consumption by material category.
             * @param {string[]} selectedCategories - Array of selected material categories.
             */
            drawStockConsumptionStackedBarChart(selectedCategories) {
                let dataToChart = this.inventoryData;
                if (selectedCategories && selectedCategories.length > 0) {
                    dataToChart = dataToChart.filter(item => selectedCategories.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryData = {};
                dataToChart.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    if (!categoryData[category]) {
                        categoryData[category] = { totalEstoqueAtual: 0, totalSaidasAnual: 0 };
                    }
                    categoryData[category].totalEstoqueAtual += item.ESTOQUE_ATUAL;
                    categoryData[category].totalSaidasAnual += item.SAIDAS_ANUAL;
                });

                const categories = Object.keys(categoryData).sort();
                const estoqueAtualValues = categories.map(cat => categoryData[cat].totalEstoqueAtual);
                const saidasAnualValues = categories.map(cat => categoryData[cat].totalSaidasAnual);

                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();
                const accentMain = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();

                const traceEstoqueAtual = {
                    x: categories,
                    y: estoqueAtualValues,
                    name: 'Estoque Atual',
                    type: 'bar',
                    marker: {
                        color: accentMain, // A primary color for stock
                        line: {
                            color: secondaryBgColor,
                            width: 1
                        }
                    },
                    hovertemplate: '<b>Categoria:</b> %{x}<br><b>Estoque Atual:</b> %{y:.0f} unidades<br><b>Porcentagem:</b> %{customdata:.0f}%<extra></extra>', // Changed to 0 decimal places
                    customdata: categories.map((cat, i) => {
                        const total = estoqueAtualValues[i] + saidasAnualValues[i];
                        return total > 0 ? (estoqueAtualValues[i] / total) * 100 : 0;
                    }),
                    text: categories.map((cat, i) => {
                        const total = estoqueAtualValues[i] + saidasAnualValues[i];
                        return total > 0 ? `${((estoqueAtualValues[i] / total) * 100).toFixed(0)}%` : '0%'; // Changed to 0 decimal places
                    }),
                    textposition: 'inside',
                    textfont: {
                        color: primaryBgColor,
                        size: 12,
                        weight: 'bold'
                    },
                };

                const traceSaidasAnual = {
                    x: categories,
                    y: saidasAnualValues,
                    name: 'Consumo Anual',
                    type: 'bar',
                    marker: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--status-alert').trim(), // A contrasting color for consumption
                        line: {
                            color: secondaryBgColor,
                            width: 1
                        }
                    },
                    hovertemplate: '<b>Categoria:</b> %{x}<br><b>Consumo Anual:</b> %{y:.0f} unidades<br><b>Porcentagem:</b> %{customdata:.0f}%<extra></extra>', // Changed to 0 decimal places
                    customdata: categories.map((cat, i) => {
                        const total = estoqueAtualValues[i] + saidasAnualValues[i];
                        return total > 0 ? (saidasAnualValues[i] / total) * 100 : 0;
                    }),
                    text: categories.map((cat, i) => {
                        const total = estoqueAtualValues[i] + saidasAnualValues[i];
                        return total > 0 ? `${((saidasAnualValues[i] / total) * 100).toFixed(0)}%` : '0%'; // Changed to 0 decimal places
                    }),
                    textposition: 'inside',
                    textfont: {
                        color: primaryBgColor,
                        size: 12,
                        weight: 'bold'
                    },
                };

                const data = [traceEstoqueAtual, traceSaidasAnual];

                const layout = {
                    barmode: 'stack',
                    barnorm: 'percent', // This makes it a 100% stacked bar chart
                    autosize: true,
                    height: 384,
                    margin: { t: 50, b: 90, l: 50, r: 30 }, // Increased bottom margin to make space for legend
                    xaxis: {
                        title: {
                            text: 'Categoria de Material',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        showgrid: true,
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Porcentagem (%)',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 14
                            }
                        },
                        tickfont: { color: textColor, size: 12 },
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        tickformat: '%', // Format y-axis as percentage
                        range: [0, 100], // Ensure it always goes from 0 to 100%
                        automargin: true
                    },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    font: {
                        color: textColor,
                        family: 'Inter',
                    },
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: { color: textColor },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                        namelength: -1
                    },
                    showlegend: true,
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: -0.4, // Adjusted to move legend further down
                        xanchor: 'center',
                        x: 0.5,
                        font: {
                            color: textColor,
                            size: 12
                        }
                    }
                };
                Plotly.react('stockVsConsumptionScatterChart', data, layout, { responsive: true, displayModeBar: false });
            },


            /**
             * Renders critical and alert items in the priority items view.
             */
            renderPriorityItems() {
                // Critical items are still defined as 'Cr√≠tico' situation AND 'A' ABC category.
                // The 'A' category is now based on CONTAGEM.
                const critical = this.inventoryData.filter(item =>
                    item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A'
                );
                const alert = this.inventoryData.filter(item =>
                    item.SITUACAO_ESTOQUE === 'Alerta'
                );

                const criticalItemsContainer = document.getElementById('criticalItems');
                const alertItemsContainer = document.getElementById('alertItems');

                criticalItemsContainer.innerHTML = '';
                alertItemsContainer.innerHTML = '';

                if (critical.length === 0) {
                    criticalItemsContainer.innerHTML = `
                        <div id="noCriticalItemsMessage" class="text-center py-8">
                            <i class="fas fa-clipboard-check text-border-color text-4xl mb-2"></i>
                            <p class="text-text-secondary">Nenhum item cr√≠tico de Categoria A identificado</p>
                        </div>
                    `;
                } else {
                    critical.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-secondary-bg p-4 rounded-lg shadow-sm flex items-center justify-between critical-item-pulse border border-status-critical';
                        itemDiv.innerHTML = `
                            <div>
                                <p class="font-semibold text-status-critical">${item.FICHA} - ${item.DESCRICAO_MATERIAL}</p>
                                <p class="text-sm text-text-secondary">Estoque: ${item.ESTOQUE_ATUAL} | Pre√ßo M√©dio: ${this.formatCurrency(item.PRECO_MEDIO)}</p>
                            </div>
                            <button class="view-item-btn text-status-critical px-3 py-1 rounded-md text-sm" data-ficha="${item.FICHA}">
                                <i class="fas fa-eye mr-1"></i>Ver Detalhes
                            </button>
                        `;
                        criticalItemsContainer.appendChild(itemDiv);
                    });
                }

                if (alert.length === 0) {
                    alertItemsContainer.innerHTML = `
                        <div id="noAlertItemsMessage" class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-border-color text-4xl mb-2"></i>
                            <p class="text-text-secondary">Nenhum item em Alerta identificado</p>
                        </div>
                    `;
                } else {
                    alert.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-secondary-bg p-4 rounded-lg shadow-sm flex items-center justify-between border border-status-alert';
                        itemDiv.innerHTML = `
                            <div>
                                <p class="font-semibold text-status-alert">${item.FICHA} - ${item.DESCRICAO_MATERIAL}</p>
                                <p class="text-sm text-text-secondary">Estoque: ${item.ESTOQUE_ATUAL} | Pre√ßo M√©dio: ${this.formatCurrency(item.PRECO_MEDIO)}</p>
                            </div>
                            <button class="view-item-btn text-status-alert px-3 py-1 rounded-md text-sm" data-ficha="${item.FICHA}">
                                <i class="fas fa-eye mr-1"></i>Ver Detalhes
                            </button>
                        `;
                        alertItemsContainer.appendChild(itemDiv);
                    });
                }
            },

            /**
             * Renders the inventory data table with current filters and sorting.
             * Implements skeleton loading.
             */
            renderTable() {
                const tableBody = document.getElementById('tableBody');
                const tableSkeleton = document.getElementById('tableSkeleton');

                // Add null checks to prevent errors if elements are not found
                if (!tableBody || !tableSkeleton) {
                    console.error("Erro: Elementos da tabela (tableBody ou tableSkeleton) n√£o foram encontrados. Certifique-se de que a visualiza√ß√£o 'Todos os Itens' est√° ativa e os elementos est√£o no DOM.");
                    return; // Exit the function if elements are missing
                }

                // Show skeleton loading
                tableBody.classList.add('hidden');
                tableSkeleton.classList.remove('hidden');

                // Clear previous sort icons and set new one
                document.querySelectorAll('#dataTable th .sort-icon').forEach(icon => {
                    icon.innerHTML = '';
                });
                const currentSortHeader = document.querySelector(`#dataTable th[data-column="${this.sortColumn}"] .sort-icon`);
                if (currentSortHeader) {
                    currentSortHeader.innerHTML = this.sortDirection === 'asc' ? '<i class="fas fa-caret-up ml-1"></i>' : '<i class="fas fa-caret-down ml-1"></i>';
                }

                // Apply filter button active states
                document.querySelectorAll('.flex-wrap button').forEach(btn => btn.classList.remove('active'));
                if (this.currentABCFilter !== 'Todos') {
                    const filterABtn = document.getElementById(`filter${this.currentABCFilter}`);
                    if (filterABtn) filterABtn.classList.add('active');
                }
                if (this.currentStockSituationFilter !== 'Todos') {
                    const filterStockBtn = document.getElementById(`filter${this.currentStockSituationFilter}`);
                    if (filterStockBtn) filterStockBtn.classList.add('active');
                }
                if (this.currentABCFilter === 'Todos' && this.currentStockSituationFilter === 'Todos' && this.currentMaterialCategoryFilter === 'Todos') {
                    const filterAllItemsBtn = document.getElementById('filterAllItems');
                    if (filterAllItemsBtn) filterAllItemsBtn.classList.add('active');
                }


                // Filter and sort data
                let currentData = [...this.inventoryData];
                if (this.currentABCFilter !== 'Todos') {
                    currentData = currentData.filter(item => item.CONCEITO === this.currentABCFilter);
                }
                if (this.currentStockSituationFilter !== 'Todos') {
                    currentData = currentData.filter(item => item.SITUACAO_ESTOQUE === this.currentStockSituationFilter);
                }
                if (this.currentMaterialCategoryFilter !== 'Todos') {
                    currentData = currentData.filter(item => item.CATEGORIA_MATERIAL === this.currentMaterialCategoryFilter);
                }

                const searchInput = document.getElementById('searchInput');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                if (searchTerm) {
                    currentData = currentData.filter(item =>
                        item.FICHA.toLowerCase().includes(searchTerm) ||
                        item.DESCRICAO_MATERIAL.toLowerCase().includes(searchTerm)
                    );
                }

                currentData.sort((a, b) => {
                    const aVal = a[this.sortColumn];
                    const bVal = b[this.sortColumn];

                    if (typeof aVal === 'string') {
                        return this.sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                });

                this.filteredData = currentData;

                const totalPagesVal = Math.ceil(this.filteredData.length / this.itemsPerPage);
                this.currentPage = Math.min(this.currentPage, totalPagesVal > 0 ? totalPagesVal : 1);
                this.currentPage = Math.max(1, this.currentPage);

                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const paginatedData = this.filteredData.slice(start, end);

                // Simulate a delay for skeleton loading effect
                setTimeout(() => {
                    tableBody.innerHTML = ''; // Clear previous content
                    paginatedData.forEach(item => {
                        const row = tableBody.insertRow();
                        let rowBorderClass = '';
                        if (item.SITUACAO_ESTOQUE === 'Cr√≠tico') {
                            rowBorderClass = 'border-l-4 border-status-critical';
                        } else if (item.SITUACAO_ESTOQUE === 'Alerta') {
                            rowBorderClass = 'border-l-4 border-status-alert';
                        } else if (item.SITUACAO_ESTOQUE === 'Normal') {
                            rowBorderClass = 'border-l-4 border-status-normal';
                        }

                        row.className = `hover:bg-border-color cursor-pointer ${rowBorderClass}`;
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-text-primary">${item.FICHA}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">${item.DESCRICAO_MATERIAL}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    ${item.CONCEITO === 'A' ? 'bg-status-critical-bg-tint text-status-critical' :
                                    item.CONCEITO === 'B' ? 'bg-status-alert-bg-tint text-status-alert' :
                                    'bg-status-normal-bg-tint text-status-normal'}">
                                    ${item.CONCEITO}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">${item.CATEGORIA_MATERIAL || 'N/A'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">${this.formatCurrency(item.PRECO_MEDIO)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-text-primary">${item.ESTOQUE_ATUAL}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    ${item.SITUACAO_ESTOQUE === 'Cr√≠tico' ? 'bg-status-critical-bg-tint text-status-critical' :
                                    item.SITUACAO_ESTOQUE === 'Alerta' ? 'bg-status-alert-bg-tint text-status-alert' :
                                    'bg-status-normal-bg-tint text-status-normal'}">
                                    ${item.SITUACAO_ESTOQUE}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                <button class="view-item-btn text-accent-main hover:text-accent-hover ml-2" data-ficha="${item.FICHA}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="delete-item-btn text-status-critical hover:text-red-700 ml-2" data-ficha="${item.FICHA}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                    });

                    // Add null checks for pagination and other elements that might not be present if the view is not fully rendered
                    const totalItemsSpan = document.getElementById('totalItems');
                    const showingItemsSpan = document.getElementById('showingItems');
                    const currentPageSpan = document.getElementById('currentPage');
                    const totalPagesSpan = document.getElementById('totalPages');
                    const prevPageBtn = document.getElementById('prevPage');
                    const nextPageBtn = document.getElementById('nextPage');

                    if (totalItemsSpan) totalItemsSpan.textContent = this.filteredData.length;
                    if (showingItemsSpan) showingItemsSpan.textContent = paginatedData.length;
                    if (currentPageSpan) currentPageSpan.textContent = this.currentPage;
                    if (totalPagesSpan) totalPagesSpan.textContent = totalPagesVal;

                    if (prevPageBtn) prevPageBtn.disabled = this.currentPage === 1;
                    if (nextPageBtn) nextPageBtn.disabled = this.currentPage === totalPagesVal || totalPagesVal === 0;

                    // Hide skeleton and show table
                    tableSkeleton.classList.add('hidden');
                    tableBody.classList.remove('hidden');
                }, 300); // Simulate network delay for skeleton effect
            },

            /**
             * Opens the item detail modal.
             * @param {string} ficha - The FICHA of the item to display.
             */
            openItemModal(ficha) {
                const item = this.inventoryData.find(d => d.FICHA === ficha);
                if (!item) return;

                document.getElementById('modalTitle').textContent = `Detalhes do Item: ${item.FICHA}`;
                document.getElementById('modalFicha').textContent = item.FICHA;
                document.getElementById('modalDescricao').textContent = item.DESCRICAO_MATERIAL;
                document.getElementById('modalPrecoMedio').textContent = this.formatCurrency(item.PRECO_MEDIO);
                document.getElementById('modalCategoriaMaterial').textContent = item.CATEGORIA_MATERIAL || 'N/A';
                document.getElementById('modalSaidaMensal').textContent = Math.round(item.SAIDAS_MENSAIS);
                document.getElementById('modalSaidas').textContent = item.SAIDAS;
                document.getElementById('modalEstoque').textContent = item.ESTOQUE_ATUAL;
                document.getElementById('modalEstoqueIdeal').textContent = Math.round(item.ESTOQUE_IDEAL);

                const modalConceitoSpan = document.getElementById('modalConceito');
                modalConceitoSpan.textContent = item.CONCEITO;
                modalConceitoSpan.className = `px-2 py-1 rounded text-xs ${
                    item.CONCEITO === 'A' ? 'bg-status-critical-bg-tint text-status-critical' :
                    item.CONCEITO === 'B' ? 'bg-status-alert-bg-tint text-status-alert' :
                    'bg-status-normal-bg-tint text-status-normal'
                }`;

                const modalSituacaoSpan = document.getElementById('modalSituacao');
                modalSituacaoSpan.textContent = item.SITUACAO_ESTOQUE;
                modalSituacaoSpan.className = `px-2 py-1 rounded text-xs ${
                    item.SITUACAO_ESTOQUE === 'Cr√≠tico' ? 'bg-status-critical-bg-tint text-status-critical' :
                    item.SITUACAO_ESTOQUE === 'Alerta' ? 'bg-status-alert-bg-tint text-status-alert' :
                    'bg-status-normal-bg-tint text-status-normal'
                }`;

                this.drawItemHistoryChart(item);
                document.getElementById('itemModal').classList.remove('hidden');
                document.getElementById('itemModal').classList.add('block');

                this.currentItemForLLM = item;

                const llmActionPlanSection = document.getElementById('llmActionPlanSection');
                const generateActionPlanBtn = document.getElementById('generateActionPlanBtn');
                // The condition for showing the LLM button remains the same: Critical AND Category A (now Category A by orders)
                if (item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A') {
                    generateActionPlanBtn.classList.remove('hidden');
                    llmActionPlanSection.classList.remove('hidden');
                    document.getElementById('llmActionPlanContent').textContent = 'Clique em "Gerar Plano de A√ß√£o" para obter sugest√µes.';
                } else {
                    generateActionPlanBtn.classList.add('hidden');
                    llmActionPlanSection.classList.add('hidden');
                }
                document.getElementById('llmLoading').classList.add('hidden');
                document.getElementById('llmError').classList.add('hidden');
            },

            /**
             * Closes the item detail modal.
             */
            closeItemModal() {
                const modal = document.getElementById('itemModal');
                modal.classList.remove('block');
                modal.classList.add('hidden');
                this.currentItemForLLM = null;
                document.getElementById('apiSimulationResult').classList.add('hidden');
                document.getElementById('apiSimulationResult').textContent = '';
            },

            /**
             * Draws the monthly sales history chart for an item.
             * @param {Object} item - The item object to chart.
             */
            drawItemHistoryChart(item) {
                const SAIDAS_MENSAIS = item.SAIDAS / 24;
                const monthlySales = Array.from({ length: 12 }, (_, i) => {
                    return SAIDAS_MENSAIS * (1 + (Math.random() * 0.2 - 0.1));
                });

                const months = Array.from({ length: 12 }, (_, i) => {
                    const date = new Date();
                    date.setMonth(date.getMonth() - (11 - i));
                    return date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                });

                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const accentMain = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();
                const secondaryBgColor = getComputedStyle(document.body).getPropertyValue('--secondary-bg').trim();
                const primaryBgColor = getComputedStyle(document.body).getPropertyValue('--primary-bg').trim();

                const data = [{
                    x: months,
                    y: monthlySales,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: accentMain, size: 8, symbol: 'circle' },
                    line: { color: accentMain, width: 2.5, shape: 'spline' },
                    name: 'Sa√≠das Mensais',
                    hovertemplate: '<b>M√™s:</b> %{x}<br><b>Quantidade:</b> %{y:.0f}<extra></extra>'
                }];

                const layout = {
                    height: 200,
                    margin: { t: 30, b: 50, l: 50, r: 30 },
                    xaxis: {
                        title: {
                            text: 'M√™s',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 12
                            }
                        },
                        tickfont: { color: textColor, size: 10 },
                        gridcolor: gridColor,
                        linecolor: textColor,
                        zerolinecolor: textColor,
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Quantidade',
                            font: {
                                color: textColor,
                                weight: 'bold',
                                size: 12
                            }
                        },
                        tickfont: { color: textColor, size: 10 },
                        gridcolor: gridColor,
                        linecolor: gridColor,
                        zerolinecolor: gridColor,
                        tickformat: ',.0s',
                        automargin: true
                    },
                    paper_bgcolor: secondaryBgColor,
                    plot_bgcolor: primaryBgColor,
                    font: {
                        color: textColor,
                        family: 'Inter',
                    },
                    hoverlabel: {
                        bgcolor: secondaryBgColor,
                        font: {
                            color: textColor
                        },
                        bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim(),
                        namelength: -1
                    }
                };
                Plotly.react('itemHistoryChart', data, layout, { responsive: true, displayModeBar: false });
            },

            /**
             * Opens the item form modal for adding or editing an item.
             * @param {Object|null} item - The item object to edit, or null for adding a new item.
             */
            openItemFormModal(item = null) {
                const modal = document.getElementById('itemFormModal');
                const title = document.getElementById('itemFormModalTitle');

                const inputs = modal.querySelectorAll('input');
                inputs.forEach(input => {
                    input.value = '';
                    const errorSpan = document.getElementById(`error${input.id.replace('form', '')}`);
                    if (errorSpan) errorSpan.classList.add('hidden');
                });

                if (item) {
                    modal.dataset.mode = 'edit';
                    title.textContent = 'Editar Item';
                    document.getElementById('formFicha').value = item.FICHA;
                    document.getElementById('formFicha').readOnly = true;
                    document.getElementById('formDescricao').value = item.DESCRICAO_MATERIAL;
                    document.getElementById('formContagem').value = item.CONTAGEM; // Populate CONTAGEM
                    document.getElementById('formSaidas').value = item.SAIDAS;
                    document.getElementById('formPrecoMedio').value = item.PRECO_MEDIO;
                    document.getElementById('formEstoqueAtual').value = item.ESTOQUE_ATUAL;
                    document.getElementById('formPlanejamento4Meses').value = item.PLANEJAMENTO_4_MESES;
                    this.currentItemBeingEdited = item;
                } else {
                    modal.dataset.mode = 'add';
                    title.textContent = 'Adicionar Novo Item';
                    document.getElementById('formFicha').readOnly = false;
                    this.currentItemBeingEdited = null;
                }
                modal.classList.remove('hidden');
                modal.classList.add('block');
                document.getElementById('formFicha').focus();
            },

            /**
             * Closes the item form modal.
             */
            closeItemFormModal() {
                const modal = document.getElementById('itemFormModal');
                modal.classList.remove('block');
                modal.classList.add('hidden');
                this.currentItemBeingEdited = null;
                modal.querySelectorAll('[id^="error"]').forEach(errorSpan => {
                    errorSpan.classList.add('hidden');
                });
            },

            /**
             * Validates a form text field.
             * @param {string} fieldId - The ID of the input field.
             * @param {string} errorMessage - The error message to display.
             * @returns {boolean} True if valid, false otherwise.
             */
            validateField(fieldId, errorMessage) {
                const input = document.getElementById(fieldId);
                const errorSpan = document.getElementById(`error${fieldId.replace('form', '')}`);
                if (!input.value.trim()) {
                    errorSpan.textContent = errorMessage;
                    errorSpan.classList.remove('hidden');
                    return false;
                }
                errorSpan.classList.add('hidden');
                return true;
            },

            /**
             * Validates a form number field.
             * @param {string} fieldId - The ID of the input field.
             * @param {string} errorMessage - The error message to display.
             * @returns {boolean} True if valid, false otherwise.
             */
            validateNumberField(fieldId, errorMessage) {
                const input = document.getElementById(fieldId);
                const errorSpan = document.getElementById(`error${fieldId.replace('form', '')}`);
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0) {
                    errorSpan.textContent = errorMessage;
                    errorSpan.classList.remove('hidden');
                    return false;
                }
                errorSpan.classList.add('hidden');
                return true;
            },

            /**
             * Saves a new or edited item to the inventory data.
             */
            saveItem() {
                const modal = document.getElementById('itemFormModal');
                const mode = modal.dataset.mode;

                let isValid = true;
                isValid = this.validateField('formFicha', 'A Ficha √© obrigat√≥ria.') && isValid;
                isValid = this.validateField('formDescricao', 'A Descri√ß√£o √© obrigat√≥ria.') && isValid;
                isValid = this.validateNumberField('formContagem', 'Contagem deve ser um n√∫mero n√£o negativo.') && isValid; // Validate CONTAGEM
                isValid = this.validateNumberField('formSaidas', 'Sa√≠das devem ser um n√∫mero n√£o negativo.') && isValid;
                isValid = this.validateNumberField('formPrecoMedio', 'Pre√ßo M√©dio deve ser um n√∫mero n√£o negativo.') && isValid;
                isValid = this.validateNumberField('formEstoqueAtual', 'Estoque Atual deve ser um n√∫mero n√£o negativo.') && isValid;
                isValid = this.validateNumberField('formPlanejamento4Meses', 'Planejamento deve ser um n√∫mero n√£o negativo.') && isValid;

                if (!isValid) {
                    App.showToast('Por favor, corrija os erros no formul√°rio.', 'error');
                    return;
                }

                const ficha = document.getElementById('formFicha').value.trim();
                const descricao = document.getElementById('formDescricao').value.trim();
                const contagem = parseFloat(document.getElementById('formContagem').value); // Get CONTAGEM value
                const saidas = parseFloat(document.getElementById('formSaidas').value);
                const precoMedio = parseFloat(document.getElementById('formPrecoMedio').value);
                const estoqueAtual = parseFloat(document.getElementById('formEstoqueAtual').value);
                const planejamento4Meses = parseFloat(document.getElementById('formPlanejamento4Meses').value);

                let itemToSave = {};

                if (mode === 'add') {
                    if (this.inventoryData.some(item => item.FICHA === ficha)) {
                        document.getElementById('errorFicha').textContent = `J√° existe um item com a Ficha "${ficha}".`;
                        document.getElementById('errorFicha').classList.remove('hidden');
                        App.showToast(`J√° existe um item com a Ficha "${ficha}".`, 'error');
                        return;
                    }
                    itemToSave = { FICHA: ficha, CATEGORIA_MATERIAL: 'Outros' };
                } else {
                    itemToSave = this.currentItemBeingEdited;
                }

                itemToSave.DESCRICAO_MATERIAL = descricao;
                itemToSave.CONTAGEM = contagem; // Assign CONTAGEM
                itemToSave.SAIDAS = saidas;
                itemToSave.PRECO_MEDIO = precoMedio;
                itemToSave.ESTOQUE_ATUAL = estoqueAtual;
                itemToSave.PLANEJAMENTO_4_MESES = planejamento4Meses;

                itemToSave.VALOR_TOTAL_ITEM = itemToSave.PRECO_MEDIO * itemToSave.ESTOQUE_ATUAL;

                const SAIDAS_MENSAIS = itemToSave.SAIDAS / 24;
                itemToSave.SAIDAS_ANUAL = itemToSave.SAIDAS / 2; // Calculate annual consumption for new/edited items

                if (SAIDAS_MENSAIS > 0) {
                    if (itemToSave.ESTOQUE_ATUAL < SAIDAS_MENSAIS) {
                        itemToSave.SITUACAO_ESTOQUE = "Cr√≠tico";
                    } else if (itemToSave.ESTOQUE_ATUAL < (2 * SAIDAS_MENSAIS)) {
                        itemToSave.SITUACAO_ESTOQUE = "Alerta";
                    } else {
                        itemToSave.SITUACAO_ESTOQUE = "Normal";
                    }
                } else {
                    itemToSave.SITUACAO_ESTOQUE = "Normal";
                }

                itemToSave.SAIDAS_MENSAIS = SAIDAS_MENSAIS;
                itemToSave.ESTOQUE_IDEAL = 4 * SAIDAS_MENSAIS;

                if (mode === 'add') {
                    this.inventoryData.push(itemToSave);
                    App.showToast('Item adicionado com sucesso!', 'success');
                } else {
                    App.showToast('Item atualizado com sucesso!', 'success');
                }

                this.runABCAnalysis(); // Recalculate ABC based on CONTAGEM
                this.runSegmentedABCAnalysis();
                this.populateMaterialCategoriesFilters();
                this.applyFilters();
                this.updateUI();
                this.saveToLocalStorage();

                this.closeItemFormModal();
            },

            /**
             * Opens the confirmation modal for item deletion.
             * @param {string} ficha - The FICHA of the item to be deleted.
             */
            openConfirmationModal(ficha) {
                this.itemToDeleteFicha = ficha;
                const item = this.inventoryData.find(d => d.FICHA === ficha);
                if (item) {
                    document.getElementById('confirmationMessage').textContent = `Tem certeza de que deseja excluir o item "${item.FICHA} - ${item.DESCRICAO_MATERIAL}"?`;
                } else {
                    document.getElementById('confirmationMessage').textContent = 'Tem certeza de que deseja excluir este item?';
                }
                document.getElementById('confirmationModal').classList.remove('hidden');
                document.getElementById('confirmationModal').classList.add('block');
            },

            /**
             * Closes the confirmation modal.
             */
            closeConfirmationModal() {
                const modal = document.getElementById('confirmationModal');
                modal.classList.remove('block');
                modal.classList.add('hidden');
                this.itemToDeleteFicha = null;
            },

            /**
             * Deletes the item confirmed for deletion.
             */
            deleteItem() {
                if (this.itemToDeleteFicha) {
                    this.inventoryData = this.inventoryData.filter(item => item.FICHA !== this.itemToDeleteFicha);
                    this.runABCAnalysis(); // Recalculate ABC based on CONTAGEM
                    this.runSegmentedABCAnalysis();
                    this.populateMaterialCategoriesFilters();
                    this.applyFilters();
                    this.updateUI();
                    this.saveToLocalStorage();
                    this.closeConfirmationModal();
                    this.closeItemModal();
                    App.showToast('Item exclu√≠do com sucesso!', 'success');
                }
            },

            /**
             * Applies the ABC category filter to the table.
             * @param {string} category - The ABC category to filter by ('A', 'B', 'C', 'Todos').
             */
            applyABCFilter(category) {
                this.currentABCFilter = category;
                this.currentPage = 1;
                this.renderTable();
            },

            /**
             * Applies the stock situation filter to the table.
             * @param {string} situation - The stock situation to filter by ('Cr√≠tico', 'Alerta', 'Normal', 'Todos').
             */
            applyStockSituationFilter(situation) {
                this.currentStockSituationFilter = situation;
                this.currentPage = 1;
                this.renderTable();
            },

            /**
             * Applies the material category filter to the table.
             * @param {string} category - The material category to filter by.
             */
            applyMaterialCategoryFilter(category) {
                this.currentMaterialCategoryFilter = category;
                this.currentPage = 1;
                this.renderTable();
            },

            /**
             * Applies all current filters and re-renders the table.
             */
            applyFilters() {
                this.renderTable();
            },

            /**
             * Sorts the table data by a given column.
             * @param {string} column - The column to sort by.
             */
            sortData(column) {
                if (this.sortColumn === column) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = column;
                    this.sortDirection = 'asc';
                }
                this.renderTable();
            },

            /**
             * Changes the current page of the table.
             * @param {number} direction - -1 for previous page, 1 for next page.
             */
            changePage(direction) {
                const totalPagesVal = Math.ceil(this.filteredData.length / this.itemsPerPage);
                this.currentPage += direction;
                if (this.currentPage < 1) this.currentPage = 1;
                if (this.currentPage > totalPagesVal) this.currentPage = totalPagesVal;
                this.renderTable();
            },

            /**
             * Populates all material category filter dropdowns, including new multi-selects.
             */
            populateMaterialCategoriesFilters() {
                const allCategories = new Set();
                this.inventoryData.forEach(item => {
                    if (item.CATEGORIA_MATERIAL) {
                        allCategories.add(item.CATEGORIA_MATERIAL);
                    }
                });
                const sortedCategories = Array.from(allCategories).sort();

                const updateFilterSelect = (selectId, currentFilter) => {
                    const selectElement = document.getElementById(selectId);
                    if (!selectElement) return;
                    selectElement.innerHTML = '<option value="Todos">Todos</option>';
                    sortedCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        selectElement.appendChild(option);
                    });
                    if (currentFilter && sortedCategories.includes(currentFilter)) {
                        selectElement.value = currentFilter;
                    } else {
                        selectElement.value = 'Todos';
                    }
                };

                // Single-select dropdowns
                updateFilterSelect('materialCategoryFilter', this.currentMaterialCategoryFilter);
                updateFilterSelect('abcMaterialCategoryFilter', this.abcChartMaterialFilter);
                updateFilterSelect('stockMaterialCategoryFilter', this.stockChartMaterialFilter);

                // Multi-select dropdowns
                const multiSelectIds = [
                    'representativeness',
                    'consumption',
                    'stockVsConsumption'
                ];

                multiSelectIds.forEach(idPrefix => {
                    const dropdownContent = document.querySelector(`#multiSelectCategoryDropdown_${idPrefix} .py-1`);
                    if (!dropdownContent) return;

                    dropdownContent.innerHTML = ''; // Clear previous content

                    sortedCategories.forEach(category => {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'flex items-center px-4 py-2 hover:bg-primary-bg';
                        checkboxDiv.innerHTML = `
                            <input id="${idPrefix}_${category.replace(/\s/g, '_')}_checkbox" type="checkbox" value="${category}" class="form-checkbox h-4 w-4 text-accent-main border-border-color rounded focus:ring-accent-main">
                            <label for="${idPrefix}_${category.replace(/\s/g, '_')}_checkbox" class="ml-2 block text-sm text-text-primary cursor-pointer">${category}</label>
                        `;
                        dropdownContent.appendChild(checkboxDiv);

                        const checkbox = checkboxDiv.querySelector('input');
                        // Set initial checked state based on current filter array
                        let currentFilterArray;
                        if (idPrefix === 'representativeness') currentFilterArray = this.representativenessDonutChartMaterialFilter;
                        else if (idPrefix === 'consumption') currentFilterArray = this.consumptionMaterialCategoryFilter;
                        else if (idPrefix === 'stockVsConsumption') currentFilterArray = this.stockVsConsumptionMaterialCategoryFilter;

                        if (currentFilterArray && currentFilterArray.includes(category)) {
                            checkbox.checked = true;
                        }

                        checkbox.addEventListener('change', (e) => {
                            const selectedCategory = e.target.value;
                            if (e.target.checked) {
                                if (!currentFilterArray.includes(selectedCategory)) {
                                    currentFilterArray.push(selectedCategory);
                                }
                            } else {
                                const index = currentFilterArray.indexOf(selectedCategory);
                                if (index > -1) {
                                    currentFilterArray.splice(index, 1);
                                }
                            }
                            // Re-render the specific chart
                            if (idPrefix === 'representativeness') this.drawRepresentativenessDonutChart(currentFilterArray);
                            else if (idPrefix === 'consumption') this.drawConsumptionByMaterialCategoryChart(currentFilterArray);
                            else if (idPrefix === 'stockVsConsumption') this.drawStockConsumptionStackedBarChart(currentFilterArray); // Updated function call
                        });
                    });
                });
            },

            /**
             * Toggles the visibility of a multi-select dropdown.
             * @param {string} dropdownId - The ID of the dropdown container.
             */
            toggleMultiSelectDropdown(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                dropdown.classList.toggle('hidden');
            },

            /**
             * Handles file input change event.
             * @param {Event} event - The change event.
             */
            handleFileInputChange(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                } else {
                    document.getElementById('fileName').textContent = '';
                    document.getElementById('fileInfo').classList.add('hidden');
                }
            },

            /**
             * Handles file drop event.
             * @param {Event}  event - The drop event.
             */
            handleFileDrop(event) {
                event.preventDefault();
                document.getElementById('dropArea').classList.remove('active');
                const file = event.dataTransfer.files[0];
                if (file) {
                    this.processFile(file);
                }
            },

            /**
             * Processes the uploaded file (Excel/ODS).
             * @param {File} file - The file to process.
             */
            processFile(file) {
                if (!file.type.match(/excel|spreadsheetml|opendocument.spreadsheet/)) {
                    document.getElementById('columnError').textContent = 'Por favor, selecione um arquivo Excel (.xlsx, .xls) ou LibreOffice Calc (.ods) v√°lido.';
                    document.getElementById('columnError').classList.remove('hidden');
                    document.getElementById('fileInfo').classList.add('hidden');
                    App.showToast('Por favor, selecione um arquivo Excel (.xlsx, .xls) ou LibreOffice Calc (.ods) v√°lido.', 'error');
                    return;
                }

                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header:1});

                        if (json.length === 0) {
                            document.getElementById('columnError').textContent = "O arquivo est√° vazio ou n√£o cont√©m dados.";
                            document.getElementById('columnError').classList.remove('hidden');
                            document.getElementById('loadingIndicator').classList.add('hidden');
                            App.showToast('O arquivo est√° vazio ou n√£o cont√©m dados.', 'error');
                            return;
                        }

                        const headers = json[0];
                        const { mappedHeaders, missingRequired } = this.mapColumns(headers);

                        if (missingRequired.length > 0) {
                            const missingColsNames = missingRequired.map(key => this.expectedColumns[key][0]).join(', ');
                            document.getElementById('columnError').innerHTML = `Erro: Colunas essenciais n√£o encontradas: <strong>${missingColsNames}</strong>. Por favor, verifique se o arquivo possui as colunas corretas ou seus sin√≥nimos.`;
                            document.getElementById('columnError').classList.remove('hidden');
                            document.getElementById('loadingIndicator').classList.add('hidden');
                            this.inventoryData = [];
                            this.updateUI();
                            App.showToast(`Erro: Colunas essenciais n√£o encontradas: ${missingColsNames}`, 'error');
                            return;
                        }

                        const processedJson = XLSX.utils.sheet_to_json(worksheet);

                        const finalData = processedJson.map(row => {
                            const newRow = {};
                            for (const key in this.expectedColumns) {
                                const foundHeader = mappedHeaders[key];
                                if (foundHeader && row[foundHeader] !== undefined) {
                                    newRow[key] = row[foundHeader];
                                } else {
                                    newRow[key] = (key === "FICHA" || key === "DESCRICAO_MATERIAL" || key === "CATEGORIA_MATERIAL") ? "" : 0;
                                }
                            }
                            return newRow;
                        });

                        this.loadData(finalData);
                        this.currentView = 'inventory';
                        this.renderView();
                    } catch (error) {
                        console.error("Erro ao ler o arquivo:", error);
                        document.getElementById('columnError').textContent = "Erro ao ler o arquivo. Certifique-se de que √© um arquivo Excel/Calc v√°lido e que as colunas necess√°rias existem.";
                        document.getElementById('columnError').classList.remove('hidden');
                        document.getElementById('fileInfo').classList.add('hidden');
                        App.showToast('Erro ao ler o arquivo. Verifique o formato.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            /**
             * Handles search input, triggering a table re-render.
             */
            handleSearchInput() {
                this.currentPage = 1;
                this.renderTable();
            },

            /**
             * Exports data to an Excel file.
             * @param {Array<Object>} data - The data to export.
             * @param {string} filename - The desired filename without extension.
             */
            exportToExcel(data, filename) {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Dados");
                XLSX.writeFile(wb, `${filename}.xlsx`);
                App.showToast(`Dados exportados para ${filename}.xlsx`, 'success');
            },

            /**
             * Exports data to a CSV file.
             * @param {Array<Object>} data - The data to export.
             * @param {string} filename - The desired filename without extension.
             */
            exportToCSV(data, filename) {
                if (data.length === 0) {
                    App.showToast("Nenhum dado para exportar para CSV.", 'info');
                    return;
                }
                const header = Object.keys(data[0]).join(',');
                const rows = data.map(row => Object.values(row).map(value => {
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(','));
                const csvContent = `${header}\n${rows.join('\n')}`;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `${filename}.csv`);
                App.showToast(`Dados exportados para ${filename}.csv`, 'success');
            },

            /**
             * Exports table data to a PDF file.
             * @param {Array<Object>} data - The data to export.
             * @param {string} filename - The desired filename without extension.
             * @param {string} title - The title for the PDF document.
             */
            exportTableToPDF(data, filename, title) {
                if (data.length === 0) {
                    App.showToast("Nenhum dado para exportar para PDF.", 'info');
                    return;
                }
                const doc = new window.jspdf.jsPDF();
                const headers = Object.keys(data[0]);
                const body = data.map(item => Object.values(item).map(value => String(value)));

                const accentMainColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();
                const primaryBgColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-bg').trim();
                const textPrimaryColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const margin = 15;

                doc.autoTable({
                    head: [headers],
                    body: body,
                    startY: 20,
                    headStyles: {
                        fillColor: accentMainColor,
                        textColor: primaryBgColor,
                        fontStyle: 'bold'
                    },
                    styles: {
                        font: 'Inter',
                        fontSize: 8,
                        textColor: textPrimaryColor,
                        lineColor: borderColor,
                        lineWidth: 0.1
                    },
                    alternateRowStyles: {
                        fillColor: primaryBgColor,
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function(data) {
                        doc.setFontSize(16);
                        doc.setTextColor(textPrimaryColor);
                        doc.text(title, data.settings.margin.left, 15);

                        doc.setFontSize(10);
                        doc.setTextColor(textPrimaryColor);
                        doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                        doc.text(`Gerado em: ${App.formatDate(Date.now())}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
                    }
                });
                doc.save(`${filename}.pdf`);
                App.showToast(`Dados exportados para ${filename}.pdf`, 'success');
            },

            /**
             * Exports a chart as a PNG image.
             * @param {string} chartId - The ID of the chart element.
             * @param {string} filename - The desired filename without extension.
             */
            exportChartAsImage(chartId, filename) {
                const chartDiv = document.getElementById(chartId);
                Plotly.toImage(chartDiv, { format: 'png', height: chartDiv.offsetHeight, width: chartDiv.offsetWidth })
                    .then(function (url) {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `${filename}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        App.showToast(`Gr√°fico exportado para ${filename}.png`, 'success');
                    }).catch(error => {
                        console.error('Erro ao exportar gr√°fico:', error);
                        App.showToast('Erro ao exportar gr√°fico.', 'error');
                    });
            },

            /**
             * Exports ABC analysis data to an Excel file (now based on CONTAGEM).
             */
            exportABCDataToExcel() {
                const countA = this.inventoryData.filter(item => item.CONCEITO === 'A').length;
                const countB = this.inventoryData.filter(item => item.CONCEITO === 'B').length;
                const countC = this.inventoryData.filter(item => item.CONCEITO === 'C').length;
                const total = countA + countB + countC;
                const data = [
                    { Categoria: 'A', 'N√∫mero de Itens': countA, 'Percentagem (%)': total > 0 ? ((countA / total) * 100).toFixed(1) : 0 },
                    { Categoria: 'B', 'N√∫mero de Itens': countB, 'Percentagem (%)': total > 0 ? ((countB / total) * 100).toFixed(1) : 0 },
                    { Categoria: 'C', 'N√∫mero de Itens': countC, 'Percentagem (%)': total > 0 ? ((countC / total) * 100).toFixed(1) : 0 }
                ];
                this.exportToExcel(data, 'analise_abc_dados_por_pedidos'); // Updated filename
            },

            /**
             * Exports stock situation data to an Excel file.
             */
            exportStockDataToExcel() {
                const stockSituations = { Cr√≠tico: 0, Alerta: 0, Normal: 0 };
                this.inventoryData.forEach(item => {
                    if (stockSituations[item.SITUACAO_ESTOQUE] !== undefined) {
                        stockSituations[item.SITUACAO_ESTOQUE]++;
                    }
                });
                const total = stockSituations.Cr√≠tico + stockSituations.Alerta + stockSituations.Normal;
                const data = [
                    { Situa√ß√£o: 'Cr√≠tico', 'N√∫mero de Itens': stockSituations.Cr√≠tico, 'Percentagem (%)': total > 0 ? ((stockSituations.Cr√≠tico / total) * 100).toFixed(1) : 0 },
                    { Situa√ß√£o: 'Alerta', 'N√∫mero de Itens': stockSituations.Alerta, 'Percentagem (%)': total > 0 ? ((stockSituations.Alerta / total) * 100).toFixed(1) : 0 },
                    { Situa√ß√£o: 'Normal', 'N√∫mero de Itens': stockSituations.Normal, 'Percentagem (%)': total > 0 ? ((stockSituations.Normal / total) * 100).toFixed(1) : 0 }
                ];
                this.exportToExcel(data, 'situacao_estoque_dados');
            },

            /**
             * Exports material category distribution data to an Excel file.
             */
            exportMaterialCategoryDataToExcel() {
                const categoryCounts = {};
                this.inventoryData.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                });

                const data = Object.entries(categoryCounts).map(([category, count]) => ({
                    'Categoria de Material': category,
                    'N√∫mero de Itens': count
                }));
                this.exportToExcel(data, 'distribuicao_por_categoria_material');
            },

            /**
             * Exports representativeness donut chart data to an Excel file.
             */
            exportRepresentativenessDonutDataToExcel() {
                let dataToExport = this.inventoryData;
                if (this.representativenessDonutChartMaterialFilter && this.representativenessDonutChartMaterialFilter.length > 0) {
                    dataToExport = dataToExport.filter(item => this.representativenessDonutChartMaterialFilter.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryValues = {};
                dataToExport.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    categoryValues[category] = (categoryValues[category] || 0) + item.VALOR_TOTAL_ITEM;
                });

                const totalValueFiltered = Object.values(categoryValues).reduce((sum, val) => sum + val, 0);

                const data = Object.entries(categoryValues).map(([category, value]) => ({
                    'Categoria de Material': category,
                    'Valor Total': value,
                    'Percentagem (%)': totalValueFiltered > 0 ? ((value / totalValueFiltered) * 100).toFixed(1) : 0
                }));
                this.exportToExcel(data, 'representatividade_por_categoria_material');
            },

            /**
             * Exports annual consumption by material category data to an Excel file.
             */
            exportConsumptionMaterialCategoryDataToExcel() {
                let dataToExport = this.inventoryData;
                if (this.consumptionMaterialCategoryFilter && this.consumptionMaterialCategoryFilter.length > 0) {
                    dataToExport = dataToExport.filter(item => this.consumptionMaterialCategoryFilter.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryConsumptionMonetary = {};
                dataToExport.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    categoryConsumptionMonetary[category] = (categoryConsumptionMonetary[category] || 0) + (item.SAIDAS_ANUAL * item.PRECO_MEDIO);
                });

                const totalConsumptionMonetaryFiltered = Object.values(categoryConsumptionMonetary).reduce((sum, val) => sum + val, 0);

                const data = Object.entries(categoryConsumptionMonetary).map(([category, consumption]) => ({
                    'Categoria de Material': category,
                    'Consumo Anual (Valor Monet√°rio)': consumption
                }));
                this.exportToExcel(data, 'consumo_anual_monetario_por_categoria_material');
            },

            /**
             * Exports stock vs. annual consumption scatter plot data to an Excel file.
             */
            exportStockVsConsumptionScatterDataToExcel() {
                let dataToExport = this.inventoryData;
                if (this.stockVsConsumptionMaterialCategoryFilter && this.stockVsConsumptionMaterialCategoryFilter.length > 0) {
                    dataToExport = dataToExport.filter(item => this.stockVsConsumptionMaterialCategoryFilter.includes(item.CATEGORIA_MATERIAL || 'Outros'));
                }

                const categoryData = {};
                dataToExport.forEach(item => {
                    const category = item.CATEGORIA_MATERIAL || 'Outros';
                    if (!categoryData[category]) {
                        categoryData[category] = { totalEstoqueAtual: 0, totalSaidasAnual: 0 };
                    }
                    categoryData[category].totalEstoqueAtual += item.ESTOQUE_ATUAL;
                    categoryData[category].totalSaidasAnual += item.SAIDAS_ANUAL;
                });

                const data = Object.entries(categoryData).map(([category, values]) => ({
                    'Categoria de Material': category,
                    'Estoque Atual Total (Unidades)': values.totalEstoqueAtual,
                    'Consumo Anual Total (Unidades)': values.totalSaidasAnual
                }));
                this.exportToExcel(data, 'estoque_vs_consumo_anual_agregado');
            },

            /**
             * Toggles dark mode on/off.
             */
            toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                const toggleBtn = document.getElementById('toggleDarkMode');
                toggleBtn.innerHTML = `<i class="fas fa-${isDarkMode ? 'sun' : 'moon'} text-xl"></i>`;
                if (this.inventoryData.length > 0 && this.currentView === 'inventory') {
                    this.renderCharts();
                }
                App.showToast(`Modo ${isDarkMode ? 'Escuro' : 'Claro'} ativado!`, 'info');
            },

            /**
             * Generates an action plan using the Gemini API for the current critical item.
             */
            async generateActionPlan() {
                if (!this.currentItemForLLM) {
                    document.getElementById('llmError').textContent = 'Nenhum item selecionado para gerar plano de a√ß√£o.';
                    document.getElementById('llmError').classList.remove('hidden');
                    App.showToast('Nenhum item selecionado para gerar plano de a√ß√£o.', 'error');
                    return;
                }

                document.getElementById('llmLoading').classList.remove('hidden');
                document.getElementById('llmActionPlanContent').textContent = '';
                document.getElementById('llmError').classList.add('hidden');
                App.showToast('Gerando plano de a√ß√£o. Aguarde...', 'info');

                const item = this.currentItemForLLM;
                const prompt = `Estou a gerir o invent√°rio de um quartel e tenho um item com as seguintes caracter√≠sticas:
                Ficha: ${item.FICHA}
                Descri√ß√£o: ${item.DESCRICAO_MATERIAL}
                Categoria do Material: ${item.CATEGORIA_MATERIAL || 'N√£o especificada'}
                Estoque Atual: ${item.ESTOQUE_ATUAL} unidades
                Sa√≠das (2 anos): ${item.SAIDAS} unidades
                Sa√≠da Mensal M√©dia: ${Math.round(item.SAIDAS_MENSAIS)} unidades
                Estoque Ideal (4 Meses): ${Math.round(item.ESTOQUE_IDEAL)} unidades
                Pre√ßo M√©dio Unit√°rio: ${this.formatCurrency(item.PRECO_MEDIO)}
                Contagem de Pedidos (√∫ltimos 2 anos): ${item.CONTAGEM}
                Situa√ß√£o: Cr√≠tico
                Categoria ABC: A (alta frequ√™ncia de pedidos, significando que √© um item com muitos pedidos nos √∫ltimos 2 anos)

                Considerando que o estoque cr√≠tico significa que o estoque atual √© menor do que as sa√≠das mensais, e o estoque em alerta significa que o estoque atual √© inferior √†s sa√≠das de 2 meses (but not critical), e o estoque normal significa que o estoque atual √© superior ou igual √†s sa√≠das de 2 meses, por favor, elabore um plano de a√ß√£o detalhado com no m√°ximo 5 pontos, para gerir este item de forma mais eficaz, considerando que √© um item de alta frequ√™ncia de pedidos e cr√≠tico, e que pertence √† categoria de material "${item.CATEGORIA_MATERIAL || 'N√£o especificada'}". Inclua sugest√µes pr√°ticas e espec√≠ficas para um ambiente militar de invent√°rio.`;

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        document.getElementById('llmActionPlanContent').textContent = text;
                        App.showToast('Plano de a√ß√£o gerado com sucesso!', 'success');
                    } else {
                        document.getElementById('llmError').textContent = 'N√£o foi poss√≠vel gerar um plano de a√ß√£o. Resposta inesperada da API.';
                        document.getElementById('llmError').classList.remove('hidden');
                        App.showToast('Erro ao gerar plano de a√ß√£o.', 'error');
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    document.getElementById('llmError').textContent = 'Erro ao conectar com a API Gemini. Verifique a sua liga√ß√£o ou tente novamente.';
                    document.getElementById('llmError').classList.remove('hidden');
                    App.showToast('Erro de conex√£o com a IA.', 'error');
                } finally {
                    document.getElementById('llmLoading').classList.add('hidden');
                }
            },

            /**
             * Simulates an API call to a supplier.
             */
            simulateApiCall() {
                const resultDiv = document.getElementById('apiSimulationResult');
                resultDiv.classList.remove('hidden');
                const item = this.currentItemForLLM;

                if (!item) {
                    resultDiv.textContent = 'Nenhum item selecionado para simular a API.';
                    App.showToast('Nenhum item selecionado para simular a API.', 'error');
                    return;
                }

                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Conectando com o fornecedor...';
                App.showToast('Simulando consulta ao fornecedor...', 'info');

                setTimeout(() => {
                    const randomStock = Math.floor(Math.random() * 200) + 50;
                    const lastUpdated = new Date().toLocaleString('pt-BR');
                    resultDiv.innerHTML = `
                        <p class="font-semibold">Simula√ß√£o de Resposta do Fornecedor para ${item.DESCRICAO_MATERIAL} (Ficha: ${item.FICHA}):</p>
                        <p>Estoque Dispon√≠vel no Fornecedor: <span class="text-accent-main font-bold">${randomStock} unidades</span></p>
                        <p>Pre√ßo de Compra Sugerido: <span class="text-accent-main font-bold">${this.formatCurrency(item.PRECO_MEDIO * 0.95 + Math.random() * item.PRECO_MEDIO * 0.1)}</span> (promo√ß√£o simulada)</p>
                        <p class="text-xs text-text-secondary">√öltima atualiza√ß√£o (simulada): ${lastUpdated}</p>
                        <p class="text-xs text-status-normal mt-2">
                            <i class="fas fa-info-circle mr-1"></i> Em um sistema real, esta informa√ß√£o seria obtida de uma API externa.
                        </p>
                    `;
                    App.showToast('Consulta ao fornecedor simulada com sucesso!', 'success');
                }, 1500);
            },

            /**
             * Saves the current inventory data and timestamp to local storage.
             */
            saveToLocalStorage() {
                try {
                    localStorage.setItem('inventoryData', JSON.stringify(this.inventoryData));
                    localStorage.setItem('importTimestamp', this.importTimestamp);
                } catch (e) {
                    console.error("Erro ao salvar no localStorage:", e);
                    App.showToast('Erro ao salvar dados localmente. Verifique o espa√ßo em disco.', 'error');
                }
            },

            /**
             * Loads inventory data and preferences from local storage.
             */
            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('inventoryData');
                    const savedTimestamp = localStorage.getItem('importTimestamp');

                    if (savedData) {
                        this.inventoryData = JSON.parse(savedData);
                        this.importTimestamp = savedTimestamp ? parseFloat(savedTimestamp) : null;

                        this.inventoryData.forEach(item => {
                            item.VALOR_TOTAL_ITEM = item.PRECO_MEDIO * item.ESTOQUE_ATUAL;
                            const SAIDAS_MENSAIS = item.SAIDAS / 24;
                            item.SAIDAS_ANUAL = item.SAIDAS / 2; // Ensure annual consumption is calculated on load
                            if (SAIDAS_MENSAIS > 0) {
                                if (item.ESTOQUE_ATUAL < SAIDAS_MENSAIS) {
                                    item.SITUACAO_ESTOQUE = "Cr√≠tico";
                                } else if (item.ESTOQUE_ATUAL < (2 * SAIDAS_MENSAIS)) {
                                    item.SITUACAO_ESTOQUE = "Alerta";
                                } else {
                                    item.SITUACAO_ESTOQUE = "Normal";
                                }
                            } else {
                                item.SITUACAO_ESTOQUE = "Normal";
                            }
                            item.SAIDAS_MENSAIS = SAIDAS_MENSAIS;
                            item.ESTOQUE_IDEAL = 4 * SAIDAS_MENSAIS;
                            if (!item.CATEGORIA_MATERIAL) {
                                item.CATEGORIA_MATERIAL = 'Outros';
                            }
                            // Ensure CONTAGEM is a number when loading from local storage
                            item.CONTAGEM = parseFloat(item.CONTAGEM || 0) || 0;
                        });
                        this.runABCAnalysis(); // Recalculate ABC based on CONTAGEM
                        this.runSegmentedABCAnalysis();
                        this.populateMaterialCategoriesFilters();

                        // Initialize multi-select filters with all categories selected by default
                        const allCategories = Array.from(new Set(this.inventoryData.map(item => item.CATEGORIA_MATERIAL || 'Outros'))).sort();
                        this.representativenessDonutChartMaterialFilter = [...allCategories];
                        this.consumptionMaterialCategoryFilter = [...allCategories];
                        this.stockVsConsumptionMaterialCategoryFilter = [...allCategories];

                        document.getElementById('fileName').textContent = 'Dados salvos localmente';
                        document.getElementById('fileInfo').classList.remove('hidden');
                        if (this.importTimestamp) {
                            document.getElementById('importDate').textContent = `(Carregado em: ${this.formatDate(this.importTimestamp)})`;
                        } else {
                            document.getElementById('importDate').textContent = `(Carregado da √∫ltima sess√£o)`;
                        }
                    }
                } catch (e) {
                    console.error("Erro ao carregar do localStorage:", e);
                    App.showToast('Erro ao carregar dados salvos. Dados antigos removidos.', 'error');
                    localStorage.removeItem('inventoryData');
                    localStorage.removeItem('importTimestamp');
                }
            },

            /**
             * Clears all saved data and settings from local storage.
             */
            clearLocalStorage() {
                localStorage.removeItem('inventoryData');
                localStorage.removeItem('importTimestamp');

                document.body.classList.remove('dark-mode');
                document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-moon text-xl"></i>';

                this.inventoryData = [];
                this.filteredData = [];
                this.currentPage = 1;
                this.sortColumn = 'FICHA';
                this.sortDirection = 'asc';
                this.currentABCFilter = 'Todos';
                this.currentStockSituationFilter = 'Todos';
                this.currentMaterialCategoryFilter = 'Todos';
                this.abcChartMaterialFilter = 'Todos';
                this.stockChartMaterialFilter = 'Todos';
                this.representativenessDonutChartMaterialFilter = [];
                this.consumptionMaterialCategoryFilter = [];
                this.stockVsConsumptionMaterialCategoryFilter = [];
                document.getElementById('fileName').textContent = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('columnError').classList.add('hidden');
                this.populateMaterialCategoriesFilters();
                this.updateUI();
                this.currentView = 'home';
                this.renderView();
                App.showToast('Todos os dados e configura√ß√µes foram limpos.', 'info');
            },

            /**
             * Renders the appropriate view based on `currentView` state.
             */
            renderView() {
                const views = {
                    home: document.getElementById('homeView'),
                    inventory: document.getElementById('inventoryView'),
                    allItems: document.getElementById('allItemsView'),
                    priorityItems: document.getElementById('priorityItemsView')
                };
                const navButtons = {
                    home: document.getElementById('navHomeBtn'),
                    inventory: document.getElementById('navInventoryBtn'),
                    allItems: document.getElementById('navAllItemsBtn'),
                    priorityItems: document.getElementById('navPriorityItemsBtn')
                };

                for (const viewId in views) {
                    views[viewId].classList.add('hidden');
                    navButtons[viewId].classList.remove('active');
                }

                views[this.currentView].classList.remove('hidden');
                navButtons[this.currentView].classList.add('active');

                if (this.currentView === 'inventory' || this.currentView === 'allItems' || this.currentView === 'priorityItems') {
                    this.updateUI();
                }
            },

            /**
             * Displays a toast notification.
             * @param {string} message - The message to display.
             * @param {'info'|'success'|'error'} type - The type of toast (info, success, error).
             * @param {number} duration - The duration in milliseconds before the toast disappears.
             */
            showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let iconClass = '';
                if (type === 'success') {
                    iconClass = 'fas fa-check-circle';
                } else if (type === 'error') {
                    iconClass = 'fas fa-times-circle';
                } else if (type === 'info') {
                    iconClass = 'fas fa-info-circle';
                }
                toast.innerHTML = `<i class="toast-icon ${iconClass}"></i><span>${message}</span>`;


                container.appendChild(toast);

                void toast.offsetWidth;
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            },

            /**
             * Generates a PDF presentation of the inventory analysis.
             */
            async generatePdfPresentation() {
                if (this.inventoryData.length === 0) {
                    App.showToast('Nenhum dado para gerar a apresenta√ß√£o. Por favor, carregue os dados primeiro.', 'info');
                    return;
                }

                App.showToast('A gerar apresenta√ß√£o em PDF. Por favor, aguarde...', 'info', 5000);

                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let yPos = margin;

                const accentMainColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-main').trim();
                const primaryBgColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-bg').trim();
                const textPrimaryColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                const textSecondaryColor = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
                const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
                const statusCriticalColor = getComputedStyle(document.documentElement).getPropertyValue('--status-critical').trim();
                const statusAlertColor = getComputedStyle(document.documentElement).getPropertyValue('--status-alert').trim();

                // --- Slide 1: Cover Page ---
                doc.setFontSize(24);
                doc.setTextColor(accentMainColor);
                doc.text('Sistema de An√°lise de Estoque - Curva ABC', pageWidth / 2, yPos + 20, { align: 'center' });
                yPos += 40;

                doc.setFontSize(16);
                doc.setTextColor(textPrimaryColor);
                doc.text('Relat√≥rio Completo de Estoque', pageWidth / 2, yPos + 10, { align: 'center' });
                yPos += 20;

                doc.setFontSize(12);
                doc.setTextColor(textSecondaryColor);
                doc.text(`Gerado em: ${this.formatDate(Date.now())}`, pageWidth / 2, pageHeight - margin - 10, { align: 'center' });

                // --- Slide 2: Dashboard Overview ---
                doc.addPage();
                yPos = margin;
                doc.setFontSize(18);
                doc.setTextColor(accentMainColor);
                doc.text('Painel de Controle e Resumo', margin, yPos);
                yPos += 15;

                doc.setFontSize(10);
                doc.setTextColor(textPrimaryColor);
                doc.text(`Valor Total do Estoque: ${this.formatCurrency(this.inventoryData.reduce((sum, item) => sum + item.VALOR_TOTAL_ITEM, 0))}`, margin, yPos);
                doc.text(`Total de Itens Cadastrados: ${this.inventoryData.length}`, margin, yPos + 5);
                yPos += 15;

                const chartPromises = [
                    Plotly.toImage(document.getElementById('abcChart'), { format: 'png', height: 384, width: 600 }),
                    Plotly.toImage(document.getElementById('stockChart'), { format: 'png', height: 384, width: 600 }),
                    Plotly.toImage(document.getElementById('materialCategoryChart'), { format: 'png', height: 384, width: 600 }),
                    Plotly.toImage(document.getElementById('representativenessDonutChart'), { format: 'png', height: 450, width: 600 }),
                    Plotly.toImage(document.getElementById('consumptionMaterialCategoryChart'), { format: 'png', height: 450, width: 600 }),
                    Plotly.toImage(document.getElementById('stockVsConsumptionScatterChart'), { format: 'png', height: 384, width: 600 })
                ];

                try {
                    const [abcChartImage, stockChartImage, materialCategoryChartImage, representativenessDonutChartImage, consumptionMaterialCategoryChartImage, stockVsConsumptionBubbleChartImage] = await Promise.all(chartPromises);

                    doc.addImage(abcChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 70);
                    yPos += 80;
                    doc.addImage(stockChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 70);
                    yPos += 80;
                    doc.addImage(materialCategoryChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 70);
                    yPos += 80;
                    doc.addImage(representativenessDonutChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 80);
                    yPos += 90;
                    doc.addImage(consumptionMaterialCategoryChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 80);
                    yPos += 90;
                    doc.addImage(stockVsConsumptionBubbleChartImage, 'PNG', margin, yPos, pageWidth - 2 * margin, 70);
                    yPos += 80;

                } catch (error) {
                    console.error('Erro ao capturar gr√°ficos:', error);
                    doc.setTextColor(statusCriticalColor);
                    doc.text('Erro ao carregar um ou mais gr√°ficos.', margin, yPos);
                    yPos += 10;
                }

                // --- Slide 3: All Items Table ---
                doc.addPage();
                yPos = margin;
                doc.setFontSize(18);
                doc.setTextColor(accentMainColor);
                doc.text('Todos os Itens do Invent√°rio', margin, yPos);
                yPos += 15;

                const tableHeaders = [
                    "Ficha", "Descri√ß√£o", "Categ. ABC", "Categ. Material", "Pre√ßo M√©dio", "Estoque", "Situa√ß√£o"
                ];
                const tableBodyData = this.inventoryData.map(item => [
                    item.FICHA,
                    item.DESCRICAO_MATERIAL,
                    item.CONCEITO,
                    item.CATEGORIA_MATERIAL || 'N/A',
                    this.formatCurrency(item.PRECO_MEDIO),
                    item.ESTOQUE_ATUAL,
                    item.SITUACAO_ESTOQUE
                ]);

                doc.autoTable({
                    head: [tableHeaders],
                    body: tableBodyData,
                    startY: yPos,
                    theme: 'striped',
                    headStyles: {
                        fillColor: accentMainColor,
                        textColor: primaryBgColor,
                        fontStyle: 'bold'
                    },
                    styles: {
                        font: 'Inter',
                        fontSize: 8,
                        textColor: textPrimaryColor,
                        lineColor: borderColor,
                        lineWidth: 0.1
                    },
                    alternateRowStyles: {
                        fillColor: primaryBgColor,
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function(data) {
                        doc.setFontSize(10);
                        doc.setTextColor(textPrimaryColor);
                        doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, margin, doc.internal.pageSize.height - 10);
                    }
                });

                // --- Slide 4: Priority Items (Critical) ---
                const criticalItems = this.inventoryData.filter(item =>
                    item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A'
                );
                if (criticalItems.length > 0) {
                    doc.addPage();
                    yPos = margin;
                    doc.setFontSize(18);
                    doc.setTextColor(statusCriticalColor);
                    doc.text('Itens Cr√≠ticos (Categoria A por Pedidos)', margin, yPos); // Updated title
                    yPos += 15;

                    doc.setFontSize(10);
                    doc.setTextColor(textPrimaryColor);
                    doc.text('Estes itens exigem aten√ß√£o imediata devido ao baixo estoque e alta frequ√™ncia de pedidos:', margin, yPos); // Updated description
                    yPos += 10;

                    const criticalTableBody = criticalItems.map(item => [
                        item.FICHA,
                        item.DESCRICAO_MATERIAL,
                        item.CATEGORIA_MATERIAL || 'N/A',
                        item.ESTOQUE_ATUAL,
                        this.formatCurrency(item.PRECO_MEDIO),
                        Math.round(item.SAIDAS_MENSAIS),
                        Math.round(item.ESTOQUE_IDEAL)
                    ]);

                    doc.autoTable({
                        head: [['Ficha', 'Descri√ß√£o', 'Categ. Material', 'Estoque Atual', 'Pre√ßo M√©dio', 'Sa√≠da Mensal M√©dia', 'Estoque Ideal']],
                        body: criticalTableBody,
                        startY: yPos,
                        theme: 'striped',
                        headStyles: {
                            fillColor: statusCriticalColor,
                            textColor: primaryBgColor,
                            fontStyle: 'bold'
                        },
                        styles: {
                            font: 'Inter',
                            fontSize: 8,
                            textColor: textPrimaryColor,
                            lineColor: borderColor,
                            lineWidth: 0.1
                        },
                        alternateRowStyles: {
                            fillColor: primaryBgColor,
                        },
                        margin: { left: margin, right: margin },
                        didDrawPage: function(data) {
                            doc.setFontSize(10);
                            doc.setTextColor(textPrimaryColor);
                            doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, margin, doc.internal.pageSize.height - 10);
                        }
                    });
                } else {
                    doc.addPage();
                    yPos = margin;
                    doc.setFontSize(18);
                    doc.setTextColor(accentMainColor);
                    doc.text('Itens Cr√≠ticos (Categoria A por Pedidos)', margin, yPos); // Updated title
                    yPos += 15;
                    doc.setFontSize(12);
                    doc.setTextColor(textSecondaryColor);
                    doc.text('Nenhum item cr√≠tico de Categoria A identificado no momento.', margin, yPos);
                }

                // --- Slide 5: Priority Items (Alert) ---
                const alertItems = this.inventoryData.filter(item =>
                    item.SITUACAO_ESTOQUE === 'Alerta'
                );
                if (alertItems.length > 0) {
                    doc.addPage();
                    yPos = margin;
                    doc.setFontSize(18);
                    doc.setTextColor(statusAlertColor);
                    doc.text('Itens em Alerta', margin, yPos);
                    yPos += 15;

                    doc.setFontSize(10);
                    doc.setTextColor(textPrimaryColor);
                    doc.text('Estes itens requerem monitoramento devido ao estoque abaixo do ideal:', margin, yPos);
                    yPos += 10;

                    const alertTableBody = alertItems.map(item => [
                        item.FICHA,
                        item.DESCRICAO_MATERIAL,
                        item.CATEGORIA_MATERIAL || 'N/A',
                        item.ESTOQUE_ATUAL,
                        this.formatCurrency(item.PRECO_MEDIO),
                        Math.round(item.SAIDAS_MENSAIS),
                        Math.round(item.ESTOQUE_IDEAL)
                    ]);

                    doc.autoTable({
                        head: [['Ficha', 'Descri√ß√£o', 'Categ. Material', 'Estoque Atual', 'Pre√ßo M√©dio', 'Sa√≠da Mensal M√©dia', 'Estoque Ideal']],
                        body: alertTableBody,
                        startY: yPos,
                        theme: 'striped',
                        headStyles: {
                            fillColor: statusAlertColor,
                            textColor: primaryBgColor,
                            fontStyle: 'bold'
                        },
                        styles: {
                            font: 'Inter',
                            fontSize: 8,
                            textColor: textPrimaryColor,
                            lineColor: borderColor,
                            lineWidth: 0.1
                        },
                        alternateRowStyles: {
                            fillColor: primaryBgColor,
                        },
                        margin: { left: margin, right: margin },
                        didDrawPage: function(data) {
                            doc.setFontSize(10);
                            doc.setTextColor(textPrimaryColor);
                            doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, margin, doc.internal.pageSize.height - 10);
                        }
                    });
                } else {
                    doc.addPage();
                    yPos = margin;
                    doc.setFontSize(18);
                    doc.setTextColor(accentMainColor);
                    doc.text('Itens em Alerta', margin, yPos);
                    yPos += 15;
                    doc.setFontSize(12);
                    doc.setTextColor(textSecondaryColor);
                    doc.text('Nenhum item em alerta identificado no momento.', margin, yPos);
                }

                doc.save('Apresentacao_Analise_Estoque.pdf');
                App.showToast('Apresenta√ß√£o PDF gerada com sucesso!', 'success');
            },

            /**
             * Loads data from Google Sheets.
             */
            async loadFromGoogleSheets() {
                // This URL assumes a Google Apps Script deployed as a web app
                // that serves JSON data from a Google Sheet.
                const url = "https://script.google.com/macros/s/AKfycbyKmMzVMTCWV8b6IJDhX2XuR1f12G4uz65tPDU5sGXgWTzBJFa2b0DW_PTFVWKdFR2svg/exec";

                document.getElementById('loadingIndicator').classList.remove('hidden');
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Erro ao buscar dados do Google Sheets.");

                    const data = await response.json();
                    await App.loadData(data);
                    App.importTimestamp = Date.now();
                    App.showToast("Dados carregados com sucesso do Google Sheets!", "success");
                } catch (error) {
                    console.error("Erro ao carregar planilha do Google Sheets:", error);
                    App.showToast("Erro ao carregar planilha do Google Sheets", "error");
                } finally {
                    document.getElementById('loadingIndicator').classList.add('hidden');
                }
            },

            /**
             * Initializes the application by setting up event listeners and loading initial data.
             */
            init() {
                // Display current system date
                const currentDate = new Date();
                document.getElementById('currentSystemDate').textContent = `Dados de 2025 - Hoje: ${currentDate.toLocaleDateString('pt-BR')}`;

                // Load dark mode preference
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode === 'true') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-sun text-xl"></i>';
                } else {
                    document.getElementById('toggleDarkMode').innerHTML = '<i class="fas fa-moon text-xl"></i>';
                }

                // Event Listeners for data input (file input, reset, sample)
                const dropArea = document.getElementById('dropArea');
                const fileInput = document.getElementById('fileInput');

                fileInput.addEventListener('change', (e) => this.handleFileInputChange(e));

                // Drag and drop events
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('active');
                });
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('active');
                });
                dropArea.addEventListener('drop', (e) => this.handleFileDrop(e));

                document.getElementById('resetData').addEventListener('click', () => {
                    this.clearLocalStorage();
                });
                document.getElementById('sampleData').addEventListener('click', () => {
                    document.getElementById('columnError').classList.add('hidden');
                    document.getElementById('fileName').textContent = 'dados_de_exemplo.json';
                    document.getElementById('fileInfo').classList.remove('hidden');
                    this.loadData(sampleData);
                    this.currentView = 'inventory';
                    this.renderView();
                });
                document.getElementById('sampleDataMain').addEventListener('click', () => {
                    document.getElementById('columnError').classList.add('hidden');
                    document.getElementById('fileName').textContent = 'dados_de_exemplo.json';
                    document.getElementById('importDate').textContent = `(Carregado em: ${this.formatDate(Date.now())})`;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    this.loadData(sampleData);
                    this.currentView = 'inventory';
                    this.renderView();
                });

                // Add New Item Button
                document.getElementById('addNewItemBtn').addEventListener('click', () => {
                    this.openItemFormModal();
                });

                // Dashboard filter buttons
                document.getElementById('filterA').addEventListener('click', () => this.applyABCFilter('A'));
                document.getElementById('filterB').addEventListener('click', () => this.applyABCFilter('B'));
                document.getElementById('filterC').addEventListener('click', () => this.applyABCFilter('C'));
                document.getElementById('filterAllItems').addEventListener('click', () => {
                    this.applyABCFilter('Todos');
                    this.applyStockSituationFilter('Todos');
                    this.applyMaterialCategoryFilter('Todos');
                });

                // New Stock Situation filters
                document.getElementById('filterCritical').addEventListener('click', () => this.applyStockSituationFilter('Cr√≠tico'));
                document.getElementById('filterAlert').addEventListener('click', () => this.applyStockSituationFilter('Alerta'));
                document.getElementById('filterNormal').addEventListener('click', () => this.applyStockSituationFilter('Normal'));

                // Material Category Filter Event Listener for table
                document.getElementById('materialCategoryFilter').addEventListener('change', (e) => {
                    this.applyMaterialCategoryFilter(e.target.value);
                });

                // Material Category Filter Event Listeners for charts (single select)
                document.getElementById('abcMaterialCategoryFilter').addEventListener('change', (e) => {
                    this.abcChartMaterialFilter = e.target.value;
                    this.drawABCChart(this.abcChartMaterialFilter);
                });
                document.getElementById('stockMaterialCategoryFilter').addEventListener('change', (e) => {
                    this.stockChartMaterialFilter = e.target.value;
                    this.drawStockChart(this.stockChartMaterialFilter);
                });

                // Event Listeners for multi-select dropdowns
                const multiSelectButtons = [
                    'multiSelectCategoryBtn_representativeness',
                    'multiSelectCategoryBtn_consumption',
                    'multiSelectCategoryBtn_stockVsConsumption'
                ];

                multiSelectButtons.forEach(btnId => {
                    document.getElementById(btnId).addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent document click from closing immediately
                        const dropdownId = btnId.replace('Btn_', 'Dropdown_');
                        this.toggleMultiSelectDropdown(dropdownId);
                    });
                });

                // Close multi-select dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    multiSelectButtons.forEach(btnId => {
                        const dropdownId = btnId.replace('Btn_', 'Dropdown_');
                        const dropdown = document.getElementById(dropdownId);
                        const button = document.getElementById(btnId);
                        if (dropdown && !dropdown.classList.contains('hidden') && !button.contains(e.target)) {
                            dropdown.classList.add('hidden');
                        }
                    });
                });

                // Drill-down for stockChart
                document.getElementById('stockChart').addEventListener('plotly_click', (data) => {
                    if (data.points && data.points.length > 0) {
                        const clickedCategory = data.points[0].x;
                        this.currentView = 'allItems';
                        this.currentStockSituationFilter = clickedCategory;
                        this.currentABCFilter = 'Todos';
                        this.currentMaterialCategoryFilter = 'Todos';
                        this.renderView();
                    }
                });


                // Search input (for All Items view)
                document.getElementById('searchInput').addEventListener('keyup', () => this.handleSearchInput());

                // Table sorting (for All Items view)
                document.querySelectorAll('#dataTable th.sortable').forEach(header => {
                    header.addEventListener('click', () => this.sortData(header.dataset.column));
                });

                // Pagination buttons (for All Items view)
                document.getElementById('prevPage').addEventListener('click', () => this.changePage(-1));
                document.getElementById('nextPage').addEventListener('click', () => this.changePage(1));

                // Export buttons for All Items table
                document.getElementById('exportAllExcel').addEventListener('click', () => this.exportToExcel(this.filteredData, 'todos_itens_estoque'));
                document.getElementById('exportAllCSV').addEventListener('click', () => this.exportToCSV(this.filteredData, 'todos_itens_estoque'));
                document.getElementById('exportAllPDF').addEventListener('click', () => this.exportTableToPDF(this.filteredData, 'Todos os Itens do Estoque', 'Todos os Itens do Estoque'));

                // Export buttons for Critical and Alert lists
                document.getElementById('exportCriticalExcel').addEventListener('click', () => this.exportToExcel(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A'), 'itens_criticos_categoria_A_pedidos')); // Updated filename
                document.getElementById('exportCriticalCSV').addEventListener('click', () => this.exportToCSV(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A'), 'itens_criticos_categoria_A_pedidos')); // Updated filename
                document.getElementById('exportCriticalPDF').addEventListener('click', () => this.exportTableToPDF(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Cr√≠tico' && item.CONCEITO === 'A'), 'Itens Cr√≠ticos (Categoria A por Pedidos)', 'Itens Cr√≠ticos (Categoria A por Pedidos)')); // Updated title and filename

                document.getElementById('exportAlertExcel').addEventListener('click', () => this.exportToExcel(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Alerta'), 'itens_em_alerta'));
                document.getElementById('exportAlertCSV').addEventListener('click', () => this.exportToCSV(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Alerta'), 'itens_em_alerta'));
                document.getElementById('exportAlertPDF').addEventListener('click', () => this.exportTableToPDF(this.inventoryData.filter(item => item.SITUACAO_ESTOQUE === 'Alerta'), 'Itens em Alerta', 'Itens em Alerta'));

                // Chart export image buttons
                document.getElementById('exportABCChart').addEventListener('click', () => this.exportChartAsImage('abcChart', 'analise_abc_por_pedidos')); // Updated filename
                document.getElementById('exportStockChart').addEventListener('click', () => this.exportChartAsImage('stockChart', 'situacao_estoque'));
                document.getElementById('exportMaterialCategoryChart').addEventListener('click', () => this.exportChartAsImage('materialCategoryChart', 'distribuicao_por_categoria_material'));
                document.getElementById('exportRepresentativenessDonutChart').addEventListener('click', () => this.exportChartAsImage('representativenessDonutChart', 'representatividade_categorias_material'));
                document.getElementById('exportConsumptionMaterialCategoryChart').addEventListener('click', () => this.exportChartAsImage('consumptionMaterialCategoryChart', 'consumo_anual_por_categoria_material_monetario')); // Updated filename
                document.getElementById('exportStockVsConsumptionChart').addEventListener('click', () => this.exportChartAsImage('stockVsConsumptionScatterChart', 'estoque_vs_consumo_anual_empilhado')); // Updated filename

                // Chart export data to Excel buttons
                document.getElementById('exportABCDataExcel').addEventListener('click', () => this.exportABCDataToExcel());
                document.getElementById('exportStockDataExcel').addEventListener('click', () => this.exportStockDataToExcel());
                document.getElementById('exportMaterialCategoryDataExcel').addEventListener('click', () => this.exportMaterialCategoryDataToExcel());
                document.getElementById('exportRepresentativenessDonutDataExcel').addEventListener('click', () => this.exportRepresentativenessDonutDataToExcel());
                document.getElementById('exportConsumptionMaterialCategoryDataExcel').addEventListener('click', () => this.exportConsumptionMaterialCategoryDataToExcel());
                document.getElementById('exportStockVsConsumptionDataExcel').addEventListener('click', () => this.exportStockVsConsumptionScatterDataToExcel());

                // Dark mode toggle
                document.getElementById('toggleDarkMode').addEventListener('click', () => this.toggleDarkMode());

                // Modal event listeners (delegation for view and delete buttons)
                document.getElementById('criticalItems').addEventListener('click', (event) => {
                    if (event.target.closest('.view-item-btn')) {
                        const ficha = event.target.closest('.view-item-btn').dataset.ficha;
                        this.openItemModal(ficha);
                    }
                });
                document.getElementById('alertItems').addEventListener('click', (event) => {
                    if (event.target.closest('.view-item-btn')) {
                        const ficha = event.target.closest('.view-item-btn').dataset.ficha;
                        this.openItemModal(ficha);
                    }
                });
                document.getElementById('tableBody').addEventListener('click', (event) => {
                    const viewBtn = event.target.closest('.view-item-btn');
                    const deleteBtn = event.target.closest('.delete-item-btn');
                    if (viewBtn) {
                        const ficha = viewBtn.dataset.ficha;
                        this.openItemModal(ficha);
                    } else if (deleteBtn) {
                        const ficha = deleteBtn.dataset.ficha;
                        this.openConfirmationModal(ficha);
                    }
                });

                document.getElementById('closeModal').addEventListener('click', () => this.closeItemModal());
                document.getElementById('itemModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('itemModal')) {
                        this.closeItemModal();
                    }
                });

                // Item Form Modal event listeners (Add/Edit)
                document.getElementById('editItemBtn').addEventListener('click', () => {
                    this.closeItemModal();
                    if (this.currentItemForLLM) {
                        this.openItemFormModal(this.currentItemForLLM);
                    }
                });
                document.getElementById('closeItemFormModal').addEventListener('click', () => this.closeItemFormModal());
                document.getElementById('cancelItemFormBtn').addEventListener('click', () => this.closeItemFormModal());
                document.getElementById('saveItemFormBtn').addEventListener('click', () => this.saveItem());
                document.getElementById('itemFormModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('itemFormModal')) {
                        this.closeItemFormModal();
                    }
                });

                // Add blur listeners for real-time validation feedback
                document.getElementById('formFicha').addEventListener('blur', () => this.validateField('formFicha', 'A Ficha √© obrigat√≥ria.'));
                document.getElementById('formDescricao').addEventListener('blur', () => this.validateField('formDescricao', 'A Descri√ß√£o √© obrigat√≥ria.'));
                document.getElementById('formContagem').addEventListener('blur', () => this.validateNumberField('formContagem', 'Contagem deve ser um n√∫mero n√£o negativo.'));
                document.getElementById('formSaidas').addEventListener('blur', () => this.validateNumberField('formSaidas', 'Sa√≠das devem ser um n√∫mero n√£o negativo.'));
                document.getElementById('formPrecoMedio').addEventListener('blur', () => this.validateNumberField('formPrecoMedio', 'Pre√ßo M√©dio deve ser um n√∫mero n√£o negativo.'));
                document.getElementById('formEstoqueAtual').addEventListener('blur', () => this.validateNumberField('formEstoqueAtual', 'Estoque Atual deve ser um n√∫mero n√£o negativo.'));
                document.getElementById('formPlanejamento4Meses').addEventListener('blur', () => this.validateNumberField('formPlanejamento4Meses', 'Planejamento deve ser um n√∫mero n√£o negativo.'));

                // LLM Action Plan button
                document.getElementById('generateActionPlanBtn').addEventListener('click', () => this.generateActionPlan());

                // API Integration Simulation button
                document.getElementById('simulateApiCallBtn').addEventListener('click', () => this.simulateApiCall());

                // Confirmation Modal event listeners
                document.getElementById('cancelDeleteBtn').addEventListener('click', () => this.closeConfirmationModal());
                document.getElementById('confirmDeleteBtn').addEventListener('click', () => this.deleteItem());
                document.getElementById('confirmationModal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('confirmationModal')) {
                        this.closeConfirmationModal();
                    }
                });

                // Event Listeners for new Home View and Navigation buttons
                document.getElementById('navHomeBtn').addEventListener('click', () => {
                    this.currentView = 'home';
                    this.renderView();
                });
                document.getElementById('navInventoryBtn').addEventListener('click', () => {
                    this.currentView = 'inventory';
                    this.renderView();
                });
                document.getElementById('navAllItemsBtn').addEventListener('click', () => {
                    this.currentView = 'allItems';
                    this.renderView();
                });
                document.getElementById('navPriorityItemsBtn').addEventListener('click', () => {
                    this.currentView = 'priorityItems';
                    this.renderView();
                });
                document.getElementById('homeGoToInventoryBtn').addEventListener('click', async () => {
                    this.currentView = 'inventory';
                    this.renderView();
                    if (this.inventoryData.length === 0) {
                        await this.loadFromGoogleSheets();
                    }
                });

                // Add listener for new presentation button
                document.getElementById('exportPresentationBtn').addEventListener('click', () => this.generatePdfPresentation());

                // Initial Data Load (from localStorage or sample)
                this.loadFromLocalStorage();
                this.renderView();
            }
        };

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
